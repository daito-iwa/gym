# TestFlightでサブスクリプションをテストする方法

## 事前準備

### 1. App Store Connectでの設定

1. **サブスクリプショングループの作成**
   - App Store Connect > マイApp > アプリを選択
   - 「サブスクリプション」タブ > 「管理」
   - 「+」ボタンで新規グループを作成
   - 参照名: 例「プレミアムサブスクリプション」

2. **サブスクリプション商品の作成**
   - グループ内で「+」ボタン
   - 商品情報を入力:
     - 参照名: Premium Monthly Subscription
     - 商品ID: `com.daito.gymnasticsai.premium_monthly_subscription`
     - 期間: 1か月
     - 価格: 500円（またはTier 2）

3. **ローカライゼーション情報の入力**
   - 少なくとも日本語版を追加
   - 表示名: 「プレミアムプラン」
   - 説明: 「全ての機能が利用可能な月額プラン」

4. **ステータスの確認**
   - ステータスが「承認準備完了」になっていることを確認
   - 「メタデータが不足」の場合は、全ての必須項目を入力

### 2. Sandboxテスターアカウントの設定

1. **App Store Connect > ユーザとアクセス > Sandboxテスター**
2. 「+」ボタンで新規テスターを作成
3. 実在しないメールアドレスを使用（例: test1@example.com）
4. パスワードを設定して保存

### 3. デバイスでの設定

1. **iPhoneの設定アプリを開く**
2. **「App Store」を選択**
3. **一番下の「Sandboxアカウント」をタップ**
4. **作成したSandboxテスターアカウントでサインイン**

## テスト手順

### 1. TestFlightアプリのインストール
- App StoreからTestFlightアプリをインストール
- 招待メールまたはリンクからアプリをインストール

### 2. 購入テスト
1. アプリを起動
2. サブスクリプション購入画面へ移動
3. 「購入」ボタンをタップ
4. Sandboxアカウントのパスワードを入力
5. 購入確認画面で「サブスクリプション登録」をタップ

### 3. 確認事項
- 購入ダイアログに「[環境: Sandbox]」と表示されること
- 価格が正しく表示されること
- 購入後、プレミアム機能が有効になること

## トラブルシューティング

### 「商品が見つかりません」エラーの場合

1. **商品IDの確認**
   ```
   iOS: com.daito.gymnasticsai.premium_monthly_subscription
   ```

2. **App Store Connectの確認**
   - 商品のステータスが「承認準備完了」か
   - 価格が設定されているか
   - ローカライゼーションが設定されているか

3. **アプリのバンドルIDの確認**
   - Xcodeで Bundle Identifier が正しいか確認
   - App Store Connectのアプリと一致しているか

4. **契約関連の確認**
   - App Store Connect > 契約/税金/口座情報
   - 有料アプリケーション契約が有効か確認

### デバッグ方法

1. **コンソールログの確認**
   - Xcodeでデバイスを接続してログを確認
   - `PurchaseManager`のデバッグログを確認

2. **StoreKitテスト**
   - Xcode > Product > StoreKit Configuration File
   - ローカルでの商品テストが可能

## 注意事項

- Sandboxでの購入は実際の課金は発生しません
- Sandboxでのサブスクリプション期間は短縮されています:
  - 1週間 → 3分
  - 1か月 → 5分
  - 1年 → 1時間
- 自動更新のテストも可能です