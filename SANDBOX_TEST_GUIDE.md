# 📱 サブスクリプション購入テスト完全ガイド

## 🧪 Step 1: Sandbox テストアカウント作成

### App Store Connect での作業
1. **App Store Connect** (https://appstoreconnect.apple.com) にアクセス
2. **「ユーザーとアクセス」** をクリック
3. **「Sandboxテスター」** をクリック
4. **「+」** ボタンで新しいテスターを作成

### テストアカウント情報（例）
```
メールアドレス: test.gymnastics@example.com
パスワード: TestPass123!
名: Test
姓: User
生年月日: 1990/01/01
地域: 日本
```

## 📱 Step 2: デバイスでのSandbox設定

### iOSデバイスでの設定
1. **「設定」** アプリを開く
2. **「App Store」** をタップ
3. 下にスクロールして **「SANDBOX ACCOUNT」** を見つける
4. **「サインイン」** をタップ
5. 作成したテストアカウントでサインイン

### ⚠️ 重要な注意点
- **本番のApple IDは絶対にサインアウトしない**
- Sandboxは別セクションです
- テスト終了後は必ずSandboxアカウントからサインアウト

## 🚀 Step 3: アプリでの購入テスト

### テスト手順
1. **Xcodeからアプリを実機にインストール**
2. **アプリを起動**
3. **プレミアム機能にアクセス**
4. **「プレミアムプランに登録」** ボタンをタップ
5. **購入確認ダイアログ** が表示される
6. **「[Sandbox] 購入する」** をタップ
7. **Touch ID/Face ID** または **パスワード** で認証

### 期待される動作
```
✅ App Store購入ダイアログが表示される
✅ 「[Sandbox]」表示でテスト環境であることが分かる
✅ 購入完了後、プレミアム機能が利用可能になる
✅ サーバーで購入検証が成功する
```

## 🔍 Step 4: 購入検証の確認

### アプリ内での確認
- プレミアム機能が使用可能になる
- サブスクリプション状態が「active」になる
- 無制限チャットが利用可能になる

### サーバーログでの確認
```bash
# サーバーログを確認
tail -f server.log

# 期待されるログ出力:
iOS purchase verification: com.daito.gymnasticsai.premium_monthly_subscription
Premium subscription activated
Purchase verification successful
```

## 🔄 Step 5: 複数回テスト

### テストパターン
1. **新規購入テスト**
2. **購入キャンセルテスト**
3. **復元テスト**
4. **期限切れテスト**（時間経過後）

### 購入履歴のリセット
```
App Store Connect → Sandboxテスター → 該当テスター → 
「購入履歴をクリア」で購入履歴をリセット可能
```

## 🆘 トラブルシューティング

### よくある問題

**❌ 「商品が見つかりません」エラー**
```
原因: App Store Connectで商品が未承認
解決: 商品の「準備完了」状態を確認
```

**❌ 「Invalid Product ID」エラー**
```
原因: 商品IDの不一致
解決: アプリ内のproduct_idとApp Store Connectの商品IDを確認
```

**❌ 購入ダイアログが表示されない**
```
原因: Sandboxアカウント未設定
解決: デバイスのSandbox設定を再確認
```

**❌ 「Communication with Apple failed」**
```
原因: ネットワーク接続またはApple側の問題
解決: WiFi接続確認、時間をおいて再試行
```

## ✅ テスト完了チェックリスト

- [ ] Sandboxテストアカウント作成完了
- [ ] デバイスでSandbox設定完了
- [ ] 新規購入テスト成功
- [ ] サーバー検証テスト成功
- [ ] プレミアム機能アクセス確認
- [ ] 購入復元テスト成功
- [ ] 購入キャンセルテスト実行

## 📊 テスト結果記録

### 購入テスト結果
```
日時: ___________
デバイス: ___________
商品ID: com.daito.gymnasticsai.premium_monthly_subscription
購入結果: [ 成功 / 失敗 ]
サーバー検証: [ 成功 / 失敗 ]
プレミアム機能: [ 利用可能 / 利用不可 ]
備考: ___________
```

---

## 🎯 重要なポイント

1. **必ずSandbox環境でテスト**（本番購入を避けるため）
2. **複数のシナリオでテスト**（成功・失敗・キャンセル）
3. **サーバー検証の動作確認**
4. **ログ出力の確認**
5. **実際のユーザー体験の確認**

**テスト完了後、必ずSandboxアカウントからサインアウトしてください！**