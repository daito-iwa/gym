# キャッシュ管理ガイド

このドキュメントは、スキルデータのキャッシュ問題を防ぐための管理手順を説明します。

## ⚠️ 重要：CSVデータを更新する際の必須手順

### 1. キャッシュ版数の更新
`lib/cache_config.dart`の`CURRENT_CACHE_VERSION`を必ずインクリメントしてください：

```dart
// 例：v2からv3に更新
static const int CURRENT_CACHE_VERSION = 3;
```

### 2. 変更履歴の記録
同ファイルのコメントに変更内容を記録してください：

```dart
/// v3: 2025-XX-XX - [変更内容を記述]
```

### 3. CSVファイル更新時のチェックリスト
- [ ] `skills_ja.csv`の更新
- [ ] `CURRENT_CACHE_VERSION`のインクリメント
- [ ] 変更履歴の記録
- [ ] テスト実行（全種目の技が正常に表示されるか確認）
- [ ] デプロイ

## 🔍 自動異常検出システム

以下の条件で異常を自動検出します：

### データ異常の判定基準
- **グループ数が2未満**：データが正常に読み込まれていない
- **難度数が3未満**：データが正常に読み込まれていない  
- **グループ1の技が80%以上**：古いキャッシュまたはソート問題
- **A難度の技が70%以上**：古いキャッシュまたはデータ問題

### 異常検出時のログ
```
🚨 異常検出: HBでグループ1の技が異常に多い(120/134)
⚠️ 警告: FXのグループ数が異常に少ない(1)
```

## 📋 トラブルシューティング

### 問題：特定種目で「グループ1・A難度ばかり」表示される

**原因**：
1. キャッシュ版数が更新されていない
2. CSVデータの形式エラー
3. ソート処理の問題

**解決手順**：
1. `cache_config.dart`の`CURRENT_CACHE_VERSION`をインクリメント
2. CSVデータの形式を確認
3. 再ビルド・デプロイ
4. ブラウザキャッシュクリア

### 問題：異常検出ログが出続ける

**原因**：
- 閾値設定が厳しすぎる
- 実際にデータに問題がある

**解決手順**：
1. `cache_config.dart`の閾値を調整
2. CSVデータの内容を再確認

## 🛠️ 開発者向け情報

### キャッシュシステムの仕組み
1. **版数管理**：各キャッシュに版数を付与
2. **自動更新**：古い版数のキャッシュを自動削除
3. **整合性チェック**：データ異常を自動検出
4. **統一ソート**：全種目でグループ→難度順ソート

### 設定の変更方法
`lib/cache_config.dart`で以下を調整可能：
- キャッシュ版数
- 異常検出の閾値
- 最低限必要なグループ・難度数

## 📈 今後の改善案

1. **自動テスト**：CSVデータの整合性を自動チェック
2. **版数自動更新**：CSVファイル変更時の自動版数インクリメント
3. **ユーザー向け通知**：データ更新時の通知機能

---

**重要**：このガイドに従わずにCSVデータを更新すると、ユーザーに古いキャッシュデータが表示される可能性があります。必ず手順に従って更新してください。