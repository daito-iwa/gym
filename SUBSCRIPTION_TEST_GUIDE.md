# 📱 サブスクリプションテストガイド

## 🎯 テスト環境の種類

### 1. **開発時テスト（Debug Build）**
- **テストモード**: 有効
- **課金**: 実際の課金なし
- **期間**: 短縮（30日→30日間のテスト）
- **用途**: 機能動作確認

### 2. **App Store Sandbox テスト**
- **テストモード**: 無効（実際のStoreKit使用）
- **課金**: テスト用アカウントで仮想課金
- **期間**: 加速（1ヶ月→数分）
- **用途**: 実際のStoreKitとの連携確認

### 3. **本番テスト（TestFlight）**
- **テストモード**: 無効
- **課金**: 実際の課金なし（TestFlightでは課金されない）
- **期間**: 実際の期間
- **用途**: 本番環境での最終確認

## 🔧 現在のテスト設定

アプリ内でテスト状態を確認する方法：

1. **アプリを起動**
2. **左上メニューボタン（≡）をタップ**
3. **設定セクションを確認**
4. **🔧 デバッグ情報** を確認（Debug buildでのみ表示）

```
🔧 デバッグ情報
テストモード: 有効/無効
ビルド: Debug/Release
プラットフォーム: iOS/Android
```

## 📋 テスト手順

### **Step 1: Debug Build でのテスト**

```bash
# 1. Debug buildで起動
flutter run

# 2. テスト確認項目
- アップグレードボタンが表示される
- 購入ボタンを押すとテスト購入が実行される
- 2秒後に成功/失敗（80%成功率）
- プレミアム状態に変更される
```

### **Step 2: Release Build でのテスト**

```bash
# 1. Release buildで起動
flutter run --release

# 2. テスト確認項目  
- テストモードが無効になっている
- 実際のApp Store/Google Playと連携する
- エラー時はテスト購入にフォールバックしない
```

### **Step 3: App Store Sandbox テスト（iOS）**

#### **準備**
1. **Sandbox テストユーザー作成**
   - App Store Connect → ユーザとアクセス → Sandbox テスター
   - 新しいテストアカウントを作成

2. **デバイス設定**
   - 設定 → App Store → Sandbox アカウント
   - 作成したテストアカウントでログイン

3. **商品設定確認**
   - App Store Connect → アプリ → アプリ内課金
   - `com.daito.gymnasticsai.premium_monthly_subscription` が「承認済み」

#### **テスト実行**
```bash
# 1. Release buildをインストール
flutter install --release

# 2. 購入テスト
- アップグレードボタンをタップ
- Sandbox購入ダイアログが表示される
- テストアカウントで購入実行
- プレミアム機能が有効化される
```

#### **加速テスト**
- **1ヶ月サブスク** → **5分間**に短縮
- 期限切れ後の挙動確認が可能

### **Step 4: Google Play Console テスト（Android）**

#### **準備**
1. **Internal Testing設定**
   - Google Play Console → テスト → 内部テスト
   - APKをアップロード

2. **ライセンステスト**
   - アカウント → ライセンステスト
   - テスト用Googleアカウントを追加

#### **テスト実行**
```bash
# 1. Internal testing からインストール
# 2. 購入テスト実行
```

## 🐛 よくある問題と解決方法

### **問題1: 「商品が見つかりません」**
**原因**: App Store Connect/Google Play Consoleで商品が未承認
**解決**: 
- App Store Connect: 商品ステータスを確認
- Google Play Console: 商品が有効になっているか確認

### **問題2: 「購入できません」**
**原因**: テストアカウントの問題
**解決**:
- Sandboxアカウントからログアウト→再ログイン
- 新しいテストアカウントを作成

### **問題3: テスト購入が本番に影響**
**原因**: Release buildでテストモードが有効
**解決**:
```dart
// purchase_manager.dart で確認
static const bool _isTestMode = kDebugMode; // ← これが正しい設定
```

### **問題4: 購入後にプレミアム機能が有効にならない**
**原因**: レシート検証の失敗
**解決**:
- ネットワーク接続確認
- サーバーログ確認
- レシート検証APIの動作確認

## 📊 テストチェックリスト

### **基本機能テスト**
- [ ] アップグレードボタンが表示される
- [ ] 購入ダイアログが表示される
- [ ] 購入キャンセルが正常に動作する
- [ ] 購入成功でプレミアム状態になる
- [ ] 購入復元が正常に動作する

### **エラーハンドリングテスト**
- [ ] ネットワーク切断時の挙動
- [ ] 購入失敗時のエラーメッセージ
- [ ] 重複購入の防止
- [ ] タイムアウト時の処理

### **状態管理テスト**
- [ ] アプリ再起動後もプレミアム状態が保持される
- [ ] サブスク期限切れ後の状態変更
- [ ] 複数デバイス間での同期

## 🚀 リリース前最終チェック

1. **Release buildでテストモードが無効** ✅
2. **App Store Connect商品設定完了** ⏳
3. **Sandbox テスト完了** ⏳
4. **TestFlight テスト完了** ⏳
5. **レシート検証サーバー動作確認** ⏳

---

**現在の状態**: Debug buildでテストモード有効、Release buildでテストモード無効に設定済み ✅