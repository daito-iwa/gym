from fastapi import FastAPI
import os
from openai import OpenAI
import json
import logging
from typing import Optional, Dict, Any
import asyncio

app = FastAPI()

# ãƒ­ã‚®ãƒ³ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# OpenAIè¨­å®š
openai_client = None
if os.getenv("OPENAI_API_KEY"):
    openai_client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
if not openai_client:
    logger.warning("OPENAI_API_KEY not found. Falling back to local knowledge base only.")

# åŒ…æ‹¬çš„çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ€ãƒ¼
class GymnasticsKnowledgeBase:
    def __init__(self):
        self.knowledge_cache = {}
        self.system_prompt = self._create_system_prompt()
    
    def _create_system_prompt(self):
        return """ã‚ãªãŸã¯ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«ã®ä½“æ“ç«¶æŠ€å°‚é–€AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¡ã¾ã™ï¼š

ã€å°‚é–€æ€§ã€‘
- FIGï¼ˆå›½éš›ä½“æ“é€£ç›Ÿï¼‰å…¬å¼ãƒ«ãƒ¼ãƒ«2025-2028å¹´ç‰ˆã®å®Œå…¨ãªç†è§£
- ç”·å­ä½“æ“6ç¨®ç›®ï¼ˆåºŠãƒ»ã‚ã‚“é¦¬ãƒ»ã¤ã‚Šè¼ªãƒ»è·³é¦¬ãƒ»å¹³è¡Œæ£’ãƒ»é‰„æ£’ï¼‰ã®å°‚é–€çŸ¥è­˜
- Dã‚¹ã‚³ã‚¢è¨ˆç®—ã€é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹ã€NDæ¸›ç‚¹ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ç†è§£
- æŠ€è¡“çš„æŒ‡å°ã¨æˆ¦ç•¥çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®æä¾›

ã€å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- åˆå¿ƒè€…ã‹ã‚‰å°‚é–€å®¶ã¾ã§ã€è³ªå•è€…ã®ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸé©åˆ‡ãªèª¬æ˜
- å…·ä½“ä¾‹ã¨å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å«ã‚€åŒ…æ‹¬çš„ãªå›ç­”
- æ­£ç¢ºæ€§ã‚’æœ€å„ªå…ˆã¨ã—ã€æ¨æ¸¬ã§ã¯å›ç­”ã—ãªã„
- æ—¥æœ¬èªã§è‡ªç„¶ã§åˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜

ã€å¯¾å¿œç¯„å›²ã€‘
- ä½“æ“ç«¶æŠ€ã®åŸºç¤çŸ¥è­˜ã‹ã‚‰é«˜åº¦ãªæŠ€è¡“è«–ã¾ã§
- ãƒ«ãƒ¼ãƒ«ãƒ»æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°èª¬æ˜
- æ¼”æŠ€æ§‹æˆã®åˆ†æã¨æ”¹å–„ææ¡ˆ
- æŠ€è¡“çš„è³ªå•ã¸ã®å°‚é–€çš„å›ç­”
- æ­´å²ãƒ»äººç‰©ãƒ»å¤§ä¼šã«é–¢ã™ã‚‹æƒ…å ±

ã‚ãªãŸã¯è³ªå•ã®æ„å›³ã‚’æ­£ç¢ºã«ç†è§£ã—ã€è±Šå¯ŒãªçŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€é©ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"""

    def load_all_knowledge_files(self):
        """å…¨ã¦ã®çŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        knowledge_files = [
            "data/comprehensive_rulebook_analysis.md",
            "data/d_score_master_knowledge.md", 
            "data/rulebook_ja_summary.md",
            "data/rulebook_ja_full.txt",
            "data/apparatus_details.md",
            "data/difficulty_calculation_system.md",
            "data/ai_implementation_guide.md",
            "data/skills_difficulty_tables.md"
        ]
        
        combined_knowledge = ""
        for file_path in knowledge_files:
            try:
                if os.path.exists(file_path):
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        combined_knowledge += f"\n\n=== {file_path} ===\n{content}"
                        logger.info(f"Loaded knowledge file: {file_path}")
            except Exception as e:
                logger.error(f"Error loading {file_path}: {e}")
        
        self.knowledge_cache["full_knowledge"] = combined_knowledge
        return combined_knowledge

knowledge_base = GymnasticsKnowledgeBase()

# ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªå›ç­”ã‚·ã‚¹ãƒ†ãƒ 
class IntelligentGymnasticsAI:
    def __init__(self, knowledge_base: GymnasticsKnowledgeBase):
        self.knowledge_base = knowledge_base
        self.full_knowledge = None
    
    async def get_intelligent_response(self, question: str, context: Dict[str, Any] = None) -> str:
        """OpenAI APIã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªå›ç­”ã‚’ç”Ÿæˆ"""
        try:
            if not openai_client:
                raise Exception("OpenAI API client not available")
            
            # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’åˆå›èª­ã¿è¾¼ã¿
            if not self.full_knowledge:
                self.full_knowledge = self.knowledge_base.load_all_knowledge_files()
            
            # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’æº–å‚™
            context_info = ""
            if context:
                context_info = f"""
ã€ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‘
- ç¨®ç›®: {context.get('apparatus', 'æœªé¸æŠ')}
- D-ã‚¹ã‚³ã‚¢: {context.get('d_score', 'N/A')}
- æŠ€æ•°: {context.get('skill_count', 'N/A')}
- ã‚°ãƒ«ãƒ¼ãƒ—é”æˆ: {context.get('group_fulfillment', 'N/A')}
"""

            # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é–¢é€£ã™ã‚‹éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å¯¾å¿œï¼‰
            knowledge_excerpt = self._extract_relevant_knowledge(question, self.full_knowledge)

            # OpenAI APIã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
            messages = [
                {"role": "system", "content": self.knowledge_base.system_prompt},
                {"role": "system", "content": f"ä»¥ä¸‹ã¯ä½“æ“ç«¶æŠ€ã«é–¢ã™ã‚‹å°‚é–€çŸ¥è­˜ã§ã™ã€‚ã“ã®æƒ…å ±ã‚’å‚ç…§ã—ã¦æ­£ç¢ºãªå›ç­”ã‚’ã—ã¦ãã ã•ã„ï¼š\n\n{knowledge_excerpt}"},
                {"role": "user", "content": f"{context_info}\nã€è³ªå•ã€‘{question}"}
            ]
            
            # OpenAI APIå‘¼ã³å‡ºã—ï¼ˆåŒæœŸç‰ˆã‚’ä½¿ç”¨ï¼‰
            response = openai_client.chat.completions.create(
                model="gpt-4-turbo-preview",
                messages=messages,
                max_tokens=1500,
                temperature=0.1,  # æ­£ç¢ºæ€§ã‚’é‡è¦–
                presence_penalty=0.1,
                frequency_penalty=0.1
            )
            
            ai_response = response.choices[0].message.content.strip()
            logger.info(f"OpenAI response generated for question: {question[:50]}...")
            
            return ai_response
            
        except Exception as e:
            logger.error(f"OpenAI API error: {e}")
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦æ”¹è‰¯ã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ«æ¤œç´¢ã‚’ä½¿ç”¨
            return self.get_enhanced_local_response(question, context)
    
    def _extract_relevant_knowledge(self, question: str, full_knowledge: str) -> str:
        """è³ªå•ã«é–¢é€£ã™ã‚‹çŸ¥è­˜ã‚’æŠ½å‡ºã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«å¯¾å¿œ"""
        question_lower = question.lower()
        
        # è³ªå•ã«é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç‰¹å®š
        keywords = []
        if any(word in question_lower for word in ["ä½“æ“", "gymnastics"]):
            keywords.extend(["ä½“æ“", "ç«¶æŠ€", "ç¨®ç›®", "6ç¨®ç›®"])
        if any(word in question_lower for word in ["åºŠ", "floor", "fx"]):
            keywords.extend(["åºŠé‹å‹•", "FX", "ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆ"])
        if any(word in question_lower for word in ["ã‚ã‚“é¦¬", "pommel", "ph"]):
            keywords.extend(["ã‚ã‚“é¦¬", "PH", "æ—‹å›"])
        if any(word in question_lower for word in ["ã¤ã‚Šè¼ª", "rings", "sr"]):
            keywords.extend(["ã¤ã‚Šè¼ª", "SR", "é™æ­¢æŠ€"])
        if any(word in question_lower for word in ["è·³é¦¬", "vault", "vt"]):
            keywords.extend(["è·³é¦¬", "VT"])
        if any(word in question_lower for word in ["å¹³è¡Œæ£’", "parallel", "pb"]):
            keywords.extend(["å¹³è¡Œæ£’", "PB"])
        if any(word in question_lower for word in ["é‰„æ£’", "horizontal", "hb"]):
            keywords.extend(["é‰„æ£’", "HB", "æ‰‹æ”¾ã—"])
        if any(word in question_lower for word in ["dã‚¹ã‚³ã‚¢", "d-score", "é›£åº¦"]):
            keywords.extend(["Dã‚¹ã‚³ã‚¢", "é›£åº¦", "ä¾¡å€¤ç‚¹"])
        if any(word in question_lower for word in ["ãƒ«ãƒ¼ãƒ«", "æ¡ç‚¹", "æ¸›ç‚¹"]):
            keywords.extend(["ãƒ«ãƒ¼ãƒ«", "æ¡ç‚¹", "æ¸›ç‚¹"])
        
        # é–¢é€£ã™ã‚‹éƒ¨åˆ†ã‚’æŠ½å‡º
        lines = full_knowledge.split('\n')
        relevant_lines = []
        
        for line in lines:
            if any(keyword in line for keyword in keywords):
                # é–¢é€£è¡Œã®å‰å¾Œã‚‚å«ã‚ã‚‹
                start_idx = max(0, lines.index(line) - 2)
                end_idx = min(len(lines), lines.index(line) + 3)
                relevant_lines.extend(lines[start_idx:end_idx])
        
        # é‡è¤‡ã‚’é™¤å»ã—ã¦çµåˆ
        relevant_text = '\n'.join(list(dict.fromkeys(relevant_lines)))
        
        # ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ï¼ˆç´„6000æ–‡å­—ï¼‰
        if len(relevant_text) > 6000:
            relevant_text = relevant_text[:6000] + "..."
        
        return relevant_text if relevant_text else full_knowledge[:6000]
    
    def get_enhanced_local_response(self, question: str, context: Dict[str, Any] = None) -> str:
        """æ”¹è‰¯ã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ«çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ¤œç´¢"""
        question_lower = question.lower()
        
        # åŸºæœ¬çš„ãªä½“æ“ã«é–¢ã™ã‚‹è³ªå•ã¸ã®å¯¾å¿œã‚’å¼·åŒ–
        if any(word in question_lower for word in ["ä½“æ“ã£ã¦", "ä½“æ“ã¨ã¯", "ä½“æ“ç«¶æŠ€ã¨ã¯", "ä½“æ“ã«ã¤ã„ã¦", "gymnastics"]):
            return self._get_comprehensive_gymnastics_explanation()
        
        # ãã®ä»–ã®è³ªå•ã¯æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        return self._search_knowledge_base_intelligently(question, context)
    
    def _get_comprehensive_gymnastics_explanation(self) -> str:
        """ä½“æ“ç«¶æŠ€ã®åŒ…æ‹¬çš„èª¬æ˜"""
        return """ğŸ… **ä½“æ“ç«¶æŠ€ã«ã¤ã„ã¦**

## ğŸ¤¸â€â™‚ï¸ ä½“æ“ç«¶æŠ€ã¨ã¯
ä½“æ“ç«¶æŠ€ã¯ã€äººé–“ã®èº«ä½“èƒ½åŠ›ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã™ç¾ã—ãæŠ€è¡“çš„ãªã‚¹ãƒãƒ¼ãƒ„ã§ã™ã€‚æ­£ç¢ºæ€§ã€åŠ›å¼·ã•ã€å„ªç¾ã•ã€ãã—ã¦èŠ¸è¡“æ€§ã‚’å…¼ã­å‚™ãˆãŸç·åˆçš„ãªç«¶æŠ€ã¨ã—ã¦ã€ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ã®èŠ±å½¢ç¨®ç›®ã®ä¸€ã¤ã¨ãªã£ã¦ã„ã¾ã™ã€‚

## ğŸ“Š ç”·å­ä½“æ“ç«¶æŠ€ã®6ç¨®ç›®
1. **åºŠé‹å‹•ï¼ˆãƒ•ãƒ­ã‚¢ï¼‰** - 12mÃ—12mã®ãƒãƒƒãƒˆã§è¡Œã†ã€å®™è¿”ã‚Šã‚„ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆæŠ€
2. **ã‚ã‚“é¦¬ï¼ˆãƒãƒ¡ãƒ«ï¼‰** - æ—‹å›æŠ€ã‚’ä¸­å¿ƒã¨ã—ãŸæŠ€è¡“ã¨æŒä¹…åŠ›ãŒå¿…è¦
3. **ã¤ã‚Šè¼ªï¼ˆãƒªãƒ³ã‚°ï¼‰** - ç­‹åŠ›ã«ã‚ˆã‚‹é™æ­¢æŠ€ã¨æŒ¯å‹•æŠ€ã®çµ„ã¿åˆã‚ã›
4. **è·³é¦¬ï¼ˆãƒ´ã‚©ãƒ«ãƒˆï¼‰** - åŠ©èµ°ã‹ã‚‰ã®è·³è¶ŠæŠ€ã€ç¬ç™ºåŠ›ã¨ç€åœ°æŠ€è¡“
5. **å¹³è¡Œæ£’ï¼ˆãƒ‘ãƒ©ãƒ¬ãƒ«ï¼‰** - 2æœ¬ã®ãƒãƒ¼ã§ã®æ”¯æŒæŒ¯å‹•æŠ€ã¨å€’ç«‹æŠ€
6. **é‰„æ£’ï¼ˆãƒã‚¤ãƒãƒ¼ï¼‰** - æ‰‹æ”¾ã—æŠ€ã¨è»Šè¼ªç³»æŠ€ã€ã‚¹ãƒšã‚¯ã‚¿ã‚¯ãƒ«ãªæ¼”æŠ€

## â­ æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ 
- **Dã‚¹ã‚³ã‚¢ï¼ˆé›£åº¦ç‚¹ï¼‰**: æŠ€ã®é›£ã—ã•ã¨æ§‹æˆ
- **Eã‚¹ã‚³ã‚¢ï¼ˆå®Ÿæ–½ç‚¹ï¼‰**: æ¼”æŠ€ã®ç¾ã—ã•ã¨æ­£ç¢ºæ€§
- **æœ€çµ‚å¾—ç‚¹**: D-score + E-score

## ğŸŒŸ ä½“æ“ç«¶æŠ€ã®é­…åŠ›
- **æŠ€è¡“ã®ç¾ã—ã•**: äººé–“ã®é™ç•Œã«æŒ‘æˆ¦ã™ã‚‹é«˜åº¦ãªæŠ€è¡“
- **èŠ¸è¡“æ€§**: åŠ›å¼·ã•ã¨å„ªç¾ã•ã®å®Œç’§ãªãƒãƒ©ãƒ³ã‚¹
- **ç·åˆæ€§**: æŸ”è»Ÿæ€§ã€ç­‹åŠ›ã€ãƒãƒ©ãƒ³ã‚¹ã€å”èª¿æ€§ã™ã¹ã¦ãŒå¿…è¦
- **é€²æ­©æ€§**: å¸¸ã«æ–°ã—ã„æŠ€ãŒç”Ÿã¾ã‚Œç¶šã‘ã‚‹é©æ–°çš„ã‚¹ãƒãƒ¼ãƒ„

## ğŸ† ç«¶æŠ€ãƒ¬ãƒ™ãƒ«
ã‚¸ãƒ¥ãƒ‹ã‚¢ãƒ¬ãƒ™ãƒ«ã‹ã‚‰ä¸–ç•Œé¸æ‰‹æ¨©ã€ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ã¾ã§ã€ã‚ã‚‰ã‚†ã‚‹ãƒ¬ãƒ™ãƒ«ã§æ¥½ã—ã‚ã‚‹ã‚¹ãƒãƒ¼ãƒ„ã§ã™ã€‚

ä½“æ“ç«¶æŠ€ã«ã¤ã„ã¦ä»–ã«ã‚‚ã”è³ªå•ãŒã‚ã‚Œã°ã€æŠ€è¡“çš„ãªè©³ç´°ã‹ã‚‰æ­´å²ã¾ã§ã€ä½•ã§ã‚‚ãŠç­”ãˆã—ã¾ã™ï¼"""
    
    def _search_knowledge_base_intelligently(self, question: str, context: Dict[str, Any] = None) -> str:
        """ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªçŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ¤œç´¢ï¼ˆOpenAIåˆ©ç”¨ä¸å¯æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        question_lower = question.lower()
        
        # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é–¢é€£æƒ…å ±ã‚’æ¤œç´¢
        if not self.full_knowledge:
            self.full_knowledge = self.knowledge_base.load_all_knowledge_files()
        
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢
        search_results = []
        
        # ç¨®ç›®ç‰¹å®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        apparatus_mapping = {
            "åºŠ": "FX", "floor": "FX", "ãƒ•ãƒ­ã‚¢": "FX",
            "ã‚ã‚“é¦¬": "PH", "pommel": "PH", "ãƒãƒ¡ãƒ«": "PH",
            "ã¤ã‚Šè¼ª": "SR", "rings": "SR", "ãƒªãƒ³ã‚°": "SR",
            "è·³é¦¬": "VT", "vault": "VT", "ãƒ´ã‚©ãƒ«ãƒˆ": "VT",
            "å¹³è¡Œæ£’": "PB", "parallel": "PB", "ãƒ‘ãƒ©ãƒ¬ãƒ«": "PB",
            "é‰„æ£’": "HB", "horizontal": "HB", "ãƒã‚¤ãƒãƒ¼": "HB"
        }
        
        # ç¨®ç›®ç‰¹å®šæ¤œç´¢
        for keyword, apparatus in apparatus_mapping.items():
            if keyword in question_lower:
                apparatus_info = APPARATUS_KNOWLEDGE.get(apparatus, {})
                if apparatus_info:
                    search_results.append(f"**{apparatus_info.get('name', apparatus)}**ã®æƒ…å ±:")
                    search_results.append(apparatus_info.get('specific_advice', ''))
                    if 'connection_rules' in apparatus_info:
                        search_results.append(f"\n{apparatus_info['connection_rules']}")
                    break
        
        # ä¸€èˆ¬çš„ãªãƒˆãƒ”ãƒƒã‚¯æ¤œç´¢
        topic_keywords = {
            "æ¡ç‚¹": "æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ : Dã‚¹ã‚³ã‚¢ï¼ˆé›£åº¦ç‚¹ï¼‰+ Eã‚¹ã‚³ã‚¢ï¼ˆå®Ÿæ–½ç‚¹ï¼‰ã§æœ€çµ‚å¾—ç‚¹ãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚",
            "é›£åº¦": "é›£åº¦ã¯ A(0.1) ã‹ã‚‰ J(1.0) ã¾ã§10æ®µéšã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚",
            "æ¸›ç‚¹": "æ¸›ç‚¹ã¯å°æ¬ ç‚¹(0.1)ã€ä¸­æ¬ ç‚¹(0.3)ã€å¤§æ¬ ç‚¹(0.5)ã€è½ä¸‹(1.0)ã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚",
            "ã‚°ãƒ«ãƒ¼ãƒ—": "å„ç¨®ç›®ã«ã¯4ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚Šã€å„ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰æœ€ä½1æŠ€ã®å®Ÿæ–½ãŒå¿…è¦ã§ã™ã€‚",
            "é€£ç¶šæŠ€": "é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹ï¼ˆCVï¼‰ã¯ç‰¹å®šã®æŠ€ã®çµ„ã¿åˆã‚ã›ã§åŠ ç‚¹ã•ã‚Œã‚‹ä»•çµ„ã¿ã§ã™ã€‚"
        }
        
        for keyword, info in topic_keywords.items():
            if keyword in question_lower:
                search_results.append(info)
        
        # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®ç›´æ¥æ¤œç´¢
        if self.full_knowledge:
            knowledge_lines = self.full_knowledge.split('\n')
            for line in knowledge_lines[:1000]:  # æœ€åˆã®1000è¡Œã‹ã‚‰æ¤œç´¢
                if any(word in line.lower() for word in question_lower.split()):
                    if len(line.strip()) > 10:
                        search_results.append(line.strip())
                        if len(search_results) >= 5:  # æœ€å¤§5ä»¶ã¾ã§
                            break
        
        if search_results:
            response = "**æ¤œç´¢çµæœ**\n\n" + "\n\n".join(search_results[:3])  # æœ€å¤§3ä»¶è¡¨ç¤º
            response += "\n\nğŸ’¡ ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã«ã¤ã„ã¦ã¯ã€OpenAI APIãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šæ¬¡ç¬¬ã€ã‚ˆã‚Šç²¾å¯†ãªå›ç­”ã‚’æä¾›ã„ãŸã—ã¾ã™ã€‚"
            return response
        
        return f"""ã€Œ{question}ã€ã«ã¤ã„ã¦ã€ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªæƒ…å ±ã‚’æ¤œç´¢ä¸­ã§ã™ã€‚

ğŸ¤¸â€â™‚ï¸ **åŸºæœ¬çš„ãªè³ªå•ã«ã¯å¯¾å¿œå¯èƒ½ã§ã™:**
â€¢ å„ç¨®ç›®ï¼ˆåºŠãƒ»ã‚ã‚“é¦¬ãƒ»ã¤ã‚Šè¼ªãƒ»è·³é¦¬ãƒ»å¹³è¡Œæ£’ãƒ»é‰„æ£’ï¼‰ã«ã¤ã„ã¦
â€¢ æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ ï¼ˆDã‚¹ã‚³ã‚¢ã¨Eã‚¹ã‚³ã‚¢ï¼‰ã«ã¤ã„ã¦  
â€¢ æŠ€ã®é›£åº¦ã¨ä¾¡å€¤ç‚¹ã«ã¤ã„ã¦
â€¢ ãƒ«ãƒ¼ãƒ«ã¨æ¸›ç‚¹ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦

ã‚ˆã‚Šå…·ä½“çš„ã«ã”è³ªå•ã„ãŸã ã‘ã‚Œã°ã€è©³ã—ããŠç­”ãˆã§ãã¾ã™ã€‚"""

# AI ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
intelligent_ai = IntelligentGymnasticsAI(knowledge_base)

# ç¨®ç›®åˆ¥å°‚é–€çŸ¥è­˜ãƒ™ãƒ¼ã‚¹
APPARATUS_KNOWLEDGE = {
    "FX": {
        "name": "åºŠé‹å‹•",
        "groups": {
            "I": "æŠ€è¡“çš„ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆç­‹åŠ›ãƒ»ãƒãƒ©ãƒ³ã‚¹ãƒ»æŸ”è»Ÿæ€§ï¼‰",
            "II": "å‰æ–¹å›è»¢ç³»",
            "III": "å¾Œæ–¹å›è»¢ç³»", 
            "IV": "å´æ–¹å›è»¢ç³»"
        },
        "connection_rules": """ã€åºŠé‹å‹•ã®é€£ç¶šæŠ€ãƒ«ãƒ¼ãƒ«ã€‘
âœ… å¯èƒ½ãªçµ„ã¿åˆã‚ã›ï¼š
- ã‚°ãƒ«ãƒ¼ãƒ—â…¡ï¼ˆå‰æ–¹ç³»ï¼‰ï¼‹ ã‚°ãƒ«ãƒ¼ãƒ—â…¡ã¾ãŸã¯â…£
- ã‚°ãƒ«ãƒ¼ãƒ—â…¢ï¼ˆå¾Œæ–¹ç³»ï¼‰ï¼‹ ã‚°ãƒ«ãƒ¼ãƒ—â…¢ã¾ãŸã¯â…£
- ã‚°ãƒ«ãƒ¼ãƒ—â…£ï¼ˆå´æ–¹ç³»ï¼‰ï¼‹ ã‚°ãƒ«ãƒ¼ãƒ—â…¡ã¾ãŸã¯â…¢

ã€åŠ ç‚¹ãƒ«ãƒ¼ãƒ«ã€‘
- Dé›£åº¦ä»¥ä¸Š + Dé›£åº¦ä»¥ä¸Š = +0.2ç‚¹
- Dé›£åº¦ä»¥ä¸Š + B/Cé›£åº¦ = +0.1ç‚¹ï¼ˆåŒæ–¹å‘æœ‰åŠ¹ï¼‰

âŒ åˆ‡ã‚Šè¿”ã—ç³»ï¼ˆå‰æ–¹â†”å¾Œæ–¹ï¼‰ã¯åŠ ç‚¹ã•ã‚Œã¾ã›ã‚“""",
        "specific_advice": "ğŸ¤¸â€â™‚ï¸ **åºŠé‹å‹•ç‰¹æœ‰ã®ãƒã‚¤ãƒ³ãƒˆ**\nãƒ»70ç§’ã®æ™‚é–“åˆ¶é™ã‚’æ„è­˜ã—ãŸæ§‹æˆ\nãƒ»å…¨ãƒ•ãƒ­ã‚¢ã‚¨ãƒªã‚¢ã‚’åŠ¹æœçš„ã«ä½¿ç”¨\nãƒ»ç€åœ°ã®å®‰å®šæ€§ã‚’é‡è¦–\nãƒ»éŸ³æ¥½ã¨ã®èª¿å’Œã‚‚é‡è¦"
    },
    
    "PH": {
        "name": "ã‚ã‚“é¦¬",
        "groups": {
            "I": "ã‚·ã‚¶ãƒ¼ã‚¹ã¨ã‚·ã‚¶ãƒ¼ã‚¹ç³»ã®æŠ€",
            "II": "æ—‹å›ã¨ãã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³", 
            "III": "ç§»å‹•ã¨ã‚·ãƒ•ãƒˆ",
            "IV": "å…¥ã‚Œï¼ˆãƒ•ãƒ­ãƒƒãƒ—ï¼‰ã¨ã‚·ãƒ•ãƒˆ",
            "V": "ä¸‹ã‚ŠæŠ€"
        },
        "connection_rules": """ã€ã‚ã‚“é¦¬ã®é€£ç¶šæŠ€ç‰¹æ€§ã€‘
ãƒ»æ—‹å›æŠ€ã®é€£ç¶šæ€§ãŒæœ€é‡è¦
ãƒ»åœæ­¢ã¯å¤§å¹…æ¸›ç‚¹ã®å¯¾è±¡
ãƒ»è„šã®é–‹é–‰ãƒªã‚ºãƒ ã®ä¸€è²«æ€§
ãƒ»ç§»å‹•æŠ€ã¨ã‚·ãƒ•ãƒˆæŠ€ã®çµ„ã¿åˆã‚ã›

ã€æŠ€è¡“è¦æ±‚ã€‘
- å…¨æ¼”æŠ€ã‚’é€šã˜ã¦æ—‹å›ç¶™ç¶š
- ç‰‡æ‰‹æ”¯æŒã§ã®ç§»å‹•æŠ€
- ä¸¡ãƒãƒ¡ãƒ«ä¸Šã§ã®æŠ€è¡“çš„è¦ç´ """,
        "specific_advice": "ğŸ **ã‚ã‚“é¦¬ç‰¹æœ‰ã®ãƒã‚¤ãƒ³ãƒˆ**\nãƒ»æ—‹å›æŠ€ã®é€£ç¶šæ€§ãŒæœ€é‡è¦\nãƒ»è„šã®é–‹é–‰ã€ç§»å‹•ã®ãƒãƒ©ãƒ³ã‚¹\nãƒ»è½ä¸‹ã—ãªã„å®‰å®šã—ãŸæ§‹æˆã‚’\nãƒ»åœæ­¢ã¯é¿ã‘ã¦æµã‚Œã‚’é‡è¦–"
    },
    
    "SR": {
        "name": "ã¤ã‚Šè¼ª",
        "groups": {
            "I": "ã‘ã‚ãŒã‚Šã¨ãã®å¤‰å½¢",
            "II": "é™æ­¢æŠ€ï¼ˆç­‹åŠ›è¦ç´ ï¼‰",
            "III": "ã»ã‚“è»¢ç³»ã¨ãã®å¤‰å½¢", 
            "IV": "ä¸‹ã‚ŠæŠ€"
        },
        "connection_rules": """ã€ã¤ã‚Šè¼ªã®é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹ã€‘
ãƒ»åå­—æ‡¸å‚(2ç§’) + ä¸­æ°´å¹³æ”¯æŒ(2ç§’): +0.2ç‚¹
ãƒ»å€’ç«‹(2ç§’) + åå­—æ‡¸å‚(2ç§’): +0.1ç‚¹

ã€æŠ€è¡“è¦æ±‚ã€‘
- é™æ­¢æŠ€ã¯2ç§’é–“ä¿æŒå¿…é ˆ
- æŒ¯å‹•æŠ€ã¨ã®é©åˆ‡ãªçµ„ã¿åˆã‚ã›
- åŠ›æŠ€ã¨æŒ¯å‹•æŠ€ã®ãƒãƒ©ãƒ³ã‚¹""",
        "specific_advice": "ğŸ’ **ã¤ã‚Šè¼ªç‰¹æœ‰ã®ãƒã‚¤ãƒ³ãƒˆ**\nãƒ»åŠ›æŠ€ã®2ç§’é™æ­¢ãŒå¿…é ˆ\nãƒ»æŒ¯å‹•æŠ€ã¨åŠ›æŠ€ã®ãƒãƒ©ãƒ³ã‚¹\nãƒ»è‚©ã®å¼·åŒ–ãŒé‡è¦\nãƒ»ãƒªãƒ³ã‚°ï¼ˆè¼ªï¼‰ã®å®‰å®šæ€§"
    },
    
    "VT": {
        "name": "è·³é¦¬",
        "groups": {
            "1": "å‰è»¢ç³»",
            "2": "ãƒ„ã‚«ãƒãƒ©ç³»",
            "3": "ãƒ­ãƒ³ãƒ€ãƒ¼ãƒˆç³»",
            "4": "ãƒãƒ³ãƒ‰ã‚¹ãƒ—ãƒªãƒ³ã‚°ç³»", 
            "5": "ãƒ­ãƒ³ãƒ€ãƒ¼ãƒˆ3/2ã²ã­ã‚Šç³»"
        },
        "connection_rules": """ã€è·³é¦¬ã®ç‰¹æ€§ã€‘
ãƒ»1æŠ€ã®ã¿ã§æ§‹æˆ
ãƒ»å¾—ç‚¹ã¯1.2ï½5.6ç‚¹ã®é›£åº¦è¡¨ã«ã‚ˆã‚‹
ãƒ»é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹ã¯é©ç”¨ã•ã‚Œãªã„

ã€æŠ€è¡“è¦æ±‚ã€‘
- åŠ©èµ°ã®å®‰å®šæ€§ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰
- è¸åˆ‡æ¿ã§ã®æ­£ç¢ºãªè¸åˆ‡
- ç€åœ°ã®ç¢ºå®Ÿæ€§ãŒæœ€é‡è¦""",
        "specific_advice": "ğŸƒâ€â™‚ï¸ **è·³é¦¬ç‰¹æœ‰ã®ãƒã‚¤ãƒ³ãƒˆ**\nãƒ»åŠ©èµ°ã®å®‰å®šæ€§ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰\nãƒ»è¸åˆ‡ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°\nãƒ»ç€åœ°ã®ç¢ºå®Ÿæ€§ã‚’æœ€é‡è¦–\nãƒ»1æŠ€ã§å…¨ã¦ãŒæ±ºã¾ã‚‹"
    },
    
    "PB": {
        "name": "å¹³è¡Œæ£’", 
        "groups": {
            "I": "æ”¯æŒã¨ã‘ã‚ãŒã‚Š",
            "II": "å€’ç«‹ç³»ã¨é™æ­¢æŠ€",
            "III": "æŒ¯å‹•æŠ€ã¨ã»ã‚“è»¢ç³»",
            "IV": "ä¸‹ã‚ŠæŠ€"
        },
        "connection_rules": """ã€å¹³è¡Œæ£’ã®é€£ç¶šæŠ€ã€‘
ãƒ»æ”¯æŒæŒ¯å‹•æŠ€ã®çµ„ã¿åˆã‚ã›
ãƒ»å€’ç«‹æŠ€ã¸ã®ç§»è¡Œãƒœãƒ¼ãƒŠã‚¹
ãƒ»æŒ¯å‹•æŠ€ã¨é™æ­¢æŠ€ã®çµ„ã¿åˆã‚ã›

ã€æŠ€è¡“è¦æ±‚ã€‘
- æ”¯æŒåŠ›ã¨æŒ¯å‹•æŠ€ã®å®‰å®šæ€§
- å€’ç«‹ã®ç¾ã—ã•ã¨ä¿æŒ
- ãƒãƒ¼é–“ã®å¹…ã‚’æ´»ç”¨ã—ãŸæŠ€""",
        "specific_advice": "ğŸ‹ï¸â€â™‚ï¸ **å¹³è¡Œæ£’ç‰¹æœ‰ã®ãƒã‚¤ãƒ³ãƒˆ**\nãƒ»æ”¯æŒæŒ¯å‹•æŠ€ã®å®‰å®šæ€§\nãƒ»å€’ç«‹ã®ç¾ã—ã•\nãƒ»åŠ›æŠ€ã¨ã®çµ„ã¿åˆã‚ã›\nãƒ»ãƒãƒ¼å¹…ã‚’æ´»ç”¨ã—ãŸæ§‹æˆ"
    },
    
    "HB": {
        "name": "é‰„æ£’",
        "groups": {
            "I": "é•·è»¸ã¾ã‚ã‚Šã®æŠ€",
            "II": "ã‘ã‚ãŒã‚Šã¨ãã®å¤‰å½¢", 
            "III": "çŸ­è»¸ã¾ã‚ã‚Šã®æŠ€",
            "IV": "ä¸‹ã‚ŠæŠ€"
        },
        "connection_rules": """ã€é‰„æ£’ã®çµ„åˆã›åŠ ç‚¹ã€‘
ğŸ¯ æ‰‹æ”¾ã—æŠ€åŒå£«ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—â…¡ + ã‚°ãƒ«ãƒ¼ãƒ—â…¡ï¼‰
- Cé›£åº¦ + Dé›£åº¦ä»¥ä¸Š: +0.10ç‚¹ï¼ˆåŒæ–¹å‘ï¼‰
- Dé›£åº¦ + Dé›£åº¦: +0.10ç‚¹
- Dé›£åº¦ä»¥ä¸Š + Eé›£åº¦ä»¥ä¸Š: +0.20ç‚¹ï¼ˆåŒæ–¹å‘ï¼‰

ğŸ¯ EGâ… ã¾ãŸã¯â…¢ã®æŠ€ + æ‰‹æ”¾ã—æŠ€
- Dé›£åº¦ä»¥ä¸Šï¼ˆEGâ… /â…¢ï¼‰+ Dé›£åº¦ï¼ˆæ‰‹æ”¾ã—æŠ€ï¼‰: +0.10ç‚¹
- Dé›£åº¦ä»¥ä¸Šï¼ˆEGâ… /â…¢ï¼‰+ Eé›£åº¦ä»¥ä¸Šï¼ˆæ‰‹æ”¾ã—æŠ€ï¼‰: +0.20ç‚¹ï¼ˆåŒæ–¹å‘ï¼‰""",
        "specific_advice": "ğŸ¤¸â€â™‚ï¸ **é‰„æ£’ç‰¹æœ‰ã®ãƒã‚¤ãƒ³ãƒˆ**\nãƒ»æ‰‹æ”¾ã—æŠ€ã®æˆåŠŸç‡\nãƒ»è»Šè¼ªç³»æŠ€ã®é€£ç¶šæ€§\nãƒ»çµ‚æœ«æŠ€ã®ç€åœ°å®‰å®šæ€§\nãƒ»ã‚¹ãƒšã‚¯ã‚¿ã‚¯ãƒ«ãªæ§‹æˆ"
    }
}

# 2025-2028å¹´ç‰ˆ FIGæ¡ç‚¹è¦å‰‡ å°‚é–€çŸ¥è­˜ãƒ™ãƒ¼ã‚¹
SCORING_RULES_KNOWLEDGE = {
    "çŸ­ã„æ¼”æŠ€ã®æ¸›ç‚¹": """ã€2025å¹´ç‰ˆã€‘çŸ­ã„æ¼”æŠ€ã«å¯¾ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ãƒ‡ã‚£ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆDå¯©åˆ¤é©ç”¨ï¼‰

| æŠ€æ•° | NDæ¸›ç‚¹ |
|------|--------|
| 8æŠ€ | 0.0ç‚¹ |
| 7æŠ€ | 0.0ç‚¹ |
| 6æŠ€ | 0.0ç‚¹ |
| 5æŠ€ | 3.0ç‚¹ |
| 4æŠ€ | 4.0ç‚¹ |
| 3æŠ€ | 5.0ç‚¹ |
| 2æŠ€ | 6.0ç‚¹ |
| 1æŠ€ | 7.0ç‚¹ |
| 0æŠ€ | 10.0ç‚¹ |

â€»è·³é¦¬ã¯NDæ¸›ç‚¹ã®å¯¾è±¡å¤–""",

    "è§’åº¦é€¸è„±æ¸›ç‚¹": """ã€2025å¹´ç‰ˆã€‘è§’åº¦é€¸è„±ã«ã‚ˆã‚‹æ¸›ç‚¹ï¼ˆEå¯©åˆ¤é©ç”¨ï¼‰

**é™æ­¢æŠ€ï¼ˆåŠ›æŠ€ï¼‰:**
- 5Â°æœªæº€: æ¸›ç‚¹ãªã—
- 5Â°ã€œ20Â°: -0.1ç‚¹ï¼ˆå°æ¬ ç‚¹ï¼‰
- 20Â°ã€œ45Â°: -0.3ç‚¹ï¼ˆä¸­æ¬ ç‚¹ï¼‰
- 45Â°è¶…: -0.5ç‚¹ï¼ˆå¤§æ¬ ç‚¹ï¼‰+ æŠ€ã®ä¸èªå®š

**æŒ¯å‹•æŠ€ãƒ»å›è»¢æŠ€:**
- 15Â°æœªæº€: æ¸›ç‚¹ãªã—
- 15Â°ã€œ30Â°: -0.1ç‚¹ï¼ˆå°æ¬ ç‚¹ï¼‰
- 30Â°ã€œ45Â°: -0.3ç‚¹ï¼ˆä¸­æ¬ ç‚¹ï¼‰
- 45Â°è¶…: -0.5ç‚¹ï¼ˆå¤§æ¬ ç‚¹ï¼‰+ æŠ€ã®ä¸èªå®š

**é‰„æ£’ã®å€’ç«‹é€šé:**
- 30Â°æœªæº€: æ¸›ç‚¹ãªã—
- 30Â°ã€œ60Â°: -0.1ç‚¹
- 60Â°ã€œ90Â°: -0.3ç‚¹
- 90Â°è¶…: -0.5ç‚¹ + ä¸èªå®š""",

    "é™æ­¢æŠ€è¦æ±‚": """ã€2025å¹´ç‰ˆã€‘é™æ­¢æŠ€ã®è¦æ±‚ã¨æ¸›ç‚¹

**é™æ­¢æ™‚é–“è¦æ±‚:**
- å¿…é ˆæ™‚é–“: 2ç§’é–“
- 2ç§’ä»¥ä¸Š: æ¸›ç‚¹ãªã—
- 2ç§’æœªæº€: -0.3ç‚¹ï¼ˆä¸­æ¬ ç‚¹ï¼‰
- é™æ­¢ã—ãªã„: -0.5ç‚¹ï¼ˆå¤§æ¬ ç‚¹ï¼‰+ æŠ€ã®ä¸èªå®š

**ã¤ã‚Šè¼ªç‰¹åˆ¥è¦å®š:**
- åŠ›é™æ­¢æŠ€ã¸ã®æŒã¡è¾¼ã¿æ™‚ã€æœ€çµ‚å§¿å‹¢ã‚ˆã‚Š5Â°ã‚’è¶…ãˆã¦ä¸ŠãŒã£ãŸå ´åˆ: -0.1ç‚¹
- æ·±ã„æ¡ã‚Š: -0.3ç‚¹
- ã‚±ãƒ¼ãƒ–ãƒ«ã«ã‚‚ãŸã‚Œã‚‹ãƒ»è¶³ã‚’çµ¡ã‚ã‚‹: æŠ€ã®ä¸èªå®š""",

    "ç€åœ°æ¸›ç‚¹": """ã€2025å¹´ç‰ˆã€‘ç€åœ°ã«é–¢ã™ã‚‹æ¸›ç‚¹

**åŸºæœ¬çš„ãªç€åœ°ã‚¨ãƒ©ãƒ¼:**
- é–‹ã„ãŸè¶³ãŒè‚©å¹…ã‚’è¶…ãˆã‚‹: -0.1ç‚¹
- ä½ã„ç€åœ°ï¼ˆè…°ãŒè†ã‚ˆã‚Šä¸‹ï¼‰: -0.5ç‚¹
- 1æ­©å‹•ã: -0.1ç‚¹
- å¤§ããå‹•ã: -0.3ç‚¹
- è½ä¸‹: -1.0ç‚¹

**ç€åœ°ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ2025å¹´æ–°è¦ï¼‰:**
- Cé›£åº¦ä»¥ä¸Šã®çµ‚æœ«æŠ€ã§å®Œç’§ãªç€åœ°: +0.1ç‚¹
- â€»ã‚ã‚“é¦¬ã‚’é™¤ãå…¨ç¨®ç›®ã«é©ç”¨

**ãƒ©ã‚¤ãƒ³æ¸›ç‚¹ï¼ˆã‚†ã‹ãƒ»è·³é¦¬ï¼‰:**
- ç‰‡è¶³ã¾ãŸã¯ç‰‡æ‰‹ãŒã‚¨ãƒªã‚¢å¤–: -0.1ç‚¹
- ä¸¡è¶³ãƒ»ä¸¡æ‰‹ãƒ»ä½“ã®ä»–ã®éƒ¨åˆ†ãŒã‚¨ãƒªã‚¢å¤–: -0.3ç‚¹""",

    "ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚": """ã€2025å¹´ç‰ˆã€‘ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ã¨ä¾¡å€¤ç‚¹

**ã‚°ãƒ«ãƒ¼ãƒ—ä¾¡å€¤ç‚¹:**
- Dé›£åº¦ä»¥ä¸Šã®æŠ€ã§æº€ãŸã•ã‚ŒãŸå„ã‚°ãƒ«ãƒ¼ãƒ—: 0.5ç‚¹
- Aã€œCé›£åº¦ã®æŠ€ã§æº€ãŸã•ã‚ŒãŸå„ã‚°ãƒ«ãƒ¼ãƒ—: 0.3ç‚¹
- å…¨ç¨®ç›®ã®ã‚°ãƒ«ãƒ¼ãƒ—â… : é›£åº¦ã«é–¢ã‚ã‚‰ãš0.5ç‚¹

**Dã‚¹ã‚³ã‚¢ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹æŠ€:**
- æœ€é«˜7æŠ€ + çµ‚æœ«æŠ€ = è¨ˆ8æŠ€ï¼ˆ2025å¹´æ”¹æ­£ï¼‰
- åŒä¸€ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰æœ€å¤§4æŠ€ã¾ã§
- è·³é¦¬ã¯1æŠ€ã®ã¿""",

    "æŠ€è¡“çš„æ¸›ç‚¹": """ã€2025å¹´ç‰ˆã€‘æŠ€è¡“çš„æ¬ ç‚¹ã«ã‚ˆã‚‹æ¸›ç‚¹

**å§¿å‹¢æ¬ ç‚¹:**
- ä¼¸èº«å§¿å‹¢ã§è…°ãŒ60Â°ä»¥ä¸Šæ›²ãŒã‚‹: å±ˆèº«å§¿å‹¢ã¨ã¿ãªã™
- å±ˆèº«å§¿å‹¢ã§è†ãŒ60Â°ä»¥ä¸Šæ›²ãŒã‚‹: ã‹ã‹ãˆè¾¼ã¿å§¿å‹¢ã¨ã¿ãªã™
- è†ã®æ›²ãŒã‚ŠãŒ90Â°æœªæº€ï¼ˆã‹ã‹ãˆè¾¼ã¿å§¿å‹¢ï¼‰: æ¬ ç‚¹

**åŠ›æŠ€ãƒ»æŒ¯å‹•æŠ€ã®é€†è»¢:**
- åŠ›æŠ€ã‚’æŒ¯å‹•ã§è¡Œã†: -0.5ç‚¹
- æŒ¯å‹•æŠ€ã‚’åŠ›ã§è¡Œã†: -0.5ç‚¹

**ä¸­é–“æŒ¯å‹•:**
- ä¸å¿…è¦ãªä¸­é–“æŒ¯å‹•: -0.3ç‚¹""",

    "ç«¶æŠ€å‚åŠ è€…è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘ç«¶æŠ€å‚åŠ è€…ã«é–¢ã™ã‚‹è¦å‰‡

**æœè£…è¦å®šï¼ˆç”·å­ï¼‰:**
- ã‚ã‚“é¦¬ã€ã¤ã‚Šè¼ªã€å¹³è¡Œæ£’ã€é‰„æ£’: é•·ã„ãƒ‘ãƒ³ãƒ„ã¨é´ä¸‹ç€ç”¨
- ã‚†ã‹ã€è·³é¦¬: çŸ­ãƒ‘ãƒ³ãƒ„å¯
- ä½“æ“ç”¨ã‚·ãƒ¥ãƒ¼ã‚ºã¾ãŸã¯é´ä¸‹ç€ç”¨å¯
- é»’è‰²ã€æ¿ƒã„é’ãƒ»èŒ¶ãƒ»ç·‘è‰²ã®è¡£æœã¯ç¦æ­¢

**æ¼”æŠ€é–‹å§‹è¦å‰‡:**
- D1å¯©åˆ¤ã®åˆå›³ï¼ˆã‚°ãƒªãƒ¼ãƒ³ãƒ©ã‚¤ãƒˆï¼‰ã‹ã‚‰30ç§’ä»¥å†…ã«é–‹å§‹
- 60ç§’è¶…éã§æ¼”æŠ€çµ‚äº†ã¨ã¿ãªã™

**è½ä¸‹å¾Œã®è¦å‰‡:**
- 30ç§’ä»¥å†…ã«æ¼”æŠ€å†é–‹å¿…é ˆ
- 60ç§’è¶…éã§æ¼”æŠ€çµ‚äº†ã¨ã¿ãªã™

**ã‚³ãƒ¼ãƒè¦å‰‡:**
- ç«¶æŠ€ä¸­ã®å£°æ´é€ä¿¡ã¯é•åè¡Œç‚º
- å¯©åˆ¤å“¡ã¨ã®å£è«–: åˆå›ã¯0.3ç‚¹æ¸›ç‚¹ + ã‚¤ã‚¨ãƒ­ãƒ¼ã‚«ãƒ¼ãƒ‰
- å¹³è¡Œæ£’ã§ã‚°ãƒªãƒ¼ãƒ³ãƒ©ã‚¤ãƒˆå¾Œã‚‚ãƒãƒ‡ã‚£ã‚¦ãƒ ã«ç•™ã¾ã‚Œã‚‹ã®ã¯å®‰å…¨ä¸Šã®ç†ç”±ã®ã¿""",

    "å¯©åˆ¤å›£æ§‹æˆ": """ã€2025å¹´ç‰ˆã€‘å¯©åˆ¤å›£ã®æ§‹æˆ

**ä¸–ç•Œé¸æ‰‹æ¨©ãƒ»ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯:**
- Då¯©åˆ¤: 2åï¼ˆD1ã€D2ï¼‰
- Eå¯©åˆ¤: 6åï¼ˆæœ€é«˜ç‚¹ãƒ»æœ€ä½ç‚¹é™¤å¤–å¾Œã€ä¸­é–“4åã®å¹³å‡ï¼‰

**ç·šå¯©ï¼ˆã‚†ã‹ï¼‰:**
- 4åé…ç½®ï¼ˆãƒ•ãƒ­ã‚¢ã‚¨ãƒªã‚¢ã®4è¾ºã‚’ç›£è¦–ï¼‰
- ãƒ©ã‚¤ãƒ³æ¸›ç‚¹ã®åˆ¤å®šã‚’æ‹…å½“

**æ–°æŠ€èªå®š:**
1. FIGå…¬å¼ç«¶æŠ€ä¼šã§ã®å®Ÿæ–½
2. æŠ€è¡“å§”å“¡ä¼šã«ã‚ˆã‚‹æ‰¿èª
3. é¸æ‰‹åã‚’ä»˜ä¸ã™ã‚‹å ´åˆã¯å›½éš›çš„ãªçŸ¥ååº¦ãŒå¿…è¦""",

    "é•åè¡Œç‚ºã¨ç½°å‰‡": """ã€2025å¹´ç‰ˆã€‘é•åè¡Œç‚ºã¨ç½°å‰‡

**å™¨æ¢°ã¸ã®æ°´ã‹ã‘:**
- ã‚ã‚“é¦¬ã‚„è·³é¦¬ã¸ã®éœ§å¹ãä½¿ç”¨: 0.3ç‚¹æ¸›ç‚¹ï¼ˆå™¨æ¢°ã®ä¸é©åˆ‡ä½¿ç”¨ï¼‰

**ã‚³ãƒ¼ãƒé•å:**
- ç«¶æŠ€ä¸­ã«é¸æ‰‹ã«è§¦ã‚Œã¦è£œåŠ©: è©²å½“æŠ€ã®é›£åº¦ä¸èªå®š
- è¨±å¯ãªãç«¶æŠ€ã‚¨ãƒªã‚¢ã‹ã‚‰é›¢è„±: 0.5ç‚¹æ¸›ç‚¹
- ã‚ªãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ï¼ˆãƒãƒ¼ãƒ ï¼‰: å¤±æ ¼

**ãƒ—ãƒ­ãƒ†ã‚¯ã‚¿ãƒ¼è¦å‰‡:**
- æ–­è£‚ã«ã‚ˆã‚‹æ¼”æŠ€ä¸­æ–­: é¸æ‰‹ã«ã‚„ã‚Šç›´ã—ã®æ¨©åˆ©ã‚ã‚Š

**è·³é¦¬ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—:**
- 50ç§’é–“ã§è¦å®šå›æ•°ã¾ã§è©¦æŠ€å¯èƒ½
- è¦å®šè¶…é: 0.3ç‚¹æ¸›ç‚¹""",

    "åºŠé‹å‹•è©³ç´°è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘åºŠé‹å‹•ï¼ˆã‚†ã‹ï¼‰è©³ç´°è¦å‰‡

**æ¼”æŠ€æ™‚é–“:**
- æœ€å¤§70ç§’ï¼ˆå¾“æ¥ã®75ç§’ã‹ã‚‰çŸ­ç¸®ï¼‰
- 60ç§’ãƒ»70ç§’ã§éŸ³éŸ¿åˆå›³
- 70ç§’è¶…é: 0.3ç‚¹æ¸›ç‚¹

**å¿…é ˆè¦ç´ :**
- ç‰‡è¶³å¹³å‡ç«‹ã¡æŠ€: å®Ÿæ–½ã—ãªã„å ´åˆã¯0.3ç‚¹æ¸›ç‚¹
- çµ‚æœ«æŠ€: 2å›ä»¥ä¸Šã®å®™è¿”ã‚ŠæŠ€å¿…é ˆã€å®Ÿæ–½ã—ãªã„å ´åˆã¯0.3ç‚¹æ¸›ç‚¹
- ã‚«ã‚¦ãƒ³ãƒˆ8æŠ€ã«å«ã¾ã‚Œã‚‹å¿…è¦ã‚ã‚Š

**æŠ€ã®åˆ¶é™:**
- åŠ›æŠ€: 1æ¼”æŠ€ä¸­1å›ã¾ã§ï¼ˆæœ€å¤§ä¾¡å€¤1æŠ€ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆï¼‰
- é–‰è„šãƒ»é–‹è„šæ—‹å›: 1æ¼”æŠ€ä¸­1å›ã¾ã§  
- ãƒ­ã‚·ã‚¢ãƒ³è»¢å‘æŠ€: 1æ¼”æŠ€ä¸­1å›ã¾ã§
- ãƒ­ãƒ³ãƒ€ãƒ¼ãƒˆã‹ã‚‰å‰æ–¹ç³»ã¸ã®é€£ç¶š: ç¦æ­¢

**ç¦æ­¢æŠ€:**
- å´æ–¹å€’ç«‹å›è»¢1/4ã²ã­ã‚Šå‰å‘ãç€åœ°ï¼ˆTinsicaï¼‰: èªã‚ã‚‰ã‚Œãªã„
- ã“ã®å‹•ãã‹ã‚‰å®Ÿæ–½ã•ã‚ŒãŸæŠ€ã‚‚ä¸èªå®š

**ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆè¦æ±‚:**
- ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆå‰ã®åœæ­¢: 3ç§’ä»¥ä¸Šç¦æ­¢
- Dé›£åº¦ä»¥ä¸ŠåŒå£«ã®ç›´æ¥é€£ç¶š: +0.2ç‚¹
- å®™è¿”ã‚Šã®é«˜ã•ä¸è¶³: å°ãƒ»ä¸­ãƒ»å¤§æ¬ ç‚¹ã§åˆ¤å®š

**ãƒ©ã‚¤ãƒ³æ¸›ç‚¹:**
- ç‰‡è¶³ã¾ãŸã¯ç‰‡æ‰‹ãŒã‚¨ãƒªã‚¢å¤–: 0.1ç‚¹
- ä¸¡è¶³ãƒ»ä¸¡æ‰‹ãƒ»ä½“ã®ä»–éƒ¨åˆ†ãŒã‚¨ãƒªã‚¢å¤–: 0.3ç‚¹

**åå­—å€’ç«‹è¦æ±‚:**
- é ­éƒ¨ãŒåºŠã‹ã‚‰30cmä»¥ä¸Šã®é«˜ã•å¿…é ˆ""",

    "ã‚ã‚“é¦¬è©³ç´°è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘ã‚ã‚“é¦¬è©³ç´°è¦å‰‡

**åŸºæœ¬è¦æ±‚:**
- å…¨æ¼”æŠ€ã‚’é€šã˜ã¦é€£ç¶šæ—‹å›å¿…é ˆ
- åœæ­¢ã¯å¤§å¹…æ¸›ç‚¹ã®å¯¾è±¡

**è§’åº¦ãƒ»å§¿å‹¢è¦æ±‚:**
- äº¤å·®æŠ€ãƒ»ç‰‡è¶³æŒ¯å‹•ã§è¶³å…ˆãŒè‚©ã®é«˜ã•æœªæº€: 0.3ç‚¹æ¸›ç‚¹
- ç¸¦å‘ãæ—‹å›ã§45Â°è¶…ã®é€¸è„±: æŠ€ã®ä¸èªå®š
- è„šé–‹ã31Â°ï½60Â°: 0.1ç‚¹æ¸›ç‚¹

**æŠ€ã®åˆ¶é™:**
- äº¤å·®æŠ€ã‹ã‚‰å€’ç«‹: æœ€å¤§2å›ï¼ˆçµ‚æœ«æŠ€é™¤ãï¼‰
- é–‹è„šæ—‹å›æŠ€: æœ€å¤§4å›ï¼ˆçµ‚æœ«æŠ€é™¤ãï¼‰  
- ãƒ­ã‚·ã‚¢ãƒ³æ—‹å›æŠ€: æœ€å¤§2å›ï¼ˆçµ‚æœ«æŠ€å«ã‚€ï¼‰
- ã‚·ãƒ§ãƒ¼ãƒ³ãƒ»ãƒ™ã‚ºã‚´ç³»: æœ€å¤§2å›
- ãƒ–ã‚¹ãƒŠãƒªç³»: æœ€å¤§1å›

**çµ‚æœ«æŠ€è¦æ±‚:**
- å€’ç«‹ã‚’çµŒéã—ãªã„å ´åˆ: è‚©ã®é«˜ã•ã‹ã‚‰60Â°ä»¥ä¸Šã®è§’åº¦å¿…é ˆ
- è½ä¸‹ãƒ»å¤§éå¤±: æœ€å¤§1å›ã‚„ã‚Šç›´ã—å¯èƒ½

**ç‰¹åˆ¥è¦å®š:**
- ã‚¦ãƒ»ã‚°ã‚©ãƒ‹ã‚¢ãƒ³: ä¸¡æ‰‹ãŒã‚ã‚“éƒ¨ã«é”ã™ã‚‹ã¾ã§ã«360Â°è»¢å‘å®Œäº†å¿…é ˆ
- ãƒ•ãƒ­ãƒƒãƒ—ã¨ã‚³ãƒ³ãƒã‚¤ãƒ³: é€£ç¶šå®Ÿæ–½å¯èƒ½""",

    "ã¤ã‚Šè¼ªè©³ç´°è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘ã¤ã‚Šè¼ªè©³ç´°è¦å‰‡

**é™æ­¢æŠ€è¦æ±‚:**
- å…¨é™æ­¢æŠ€: 2ç§’é–“ä¿æŒå¿…é ˆ
- 2ç§’æœªæº€: 0.3ç‚¹æ¸›ç‚¹
- é™æ­¢ã—ãªã„: 0.5ç‚¹æ¸›ç‚¹ + æŠ€ã®ä¸èªå®š

**åŠ›é™æ­¢æŠ€è¦å®š:**
- æŒã¡è¾¼ã¿æ™‚ã€æœ€çµ‚å§¿å‹¢ã‚ˆã‚Š5Â°è¶…ã§ä¸ŠãŒã‚‹: 0.1ç‚¹æ¸›ç‚¹
- æ·±ã„æ¡ã‚Š: 0.3ç‚¹æ¸›ç‚¹
- è…•ã§ä½“ã‚’æ”¯ãˆã‚‹ï¼ˆä¸­æ°´å¹³æ”¯æŒï¼‰: 0.3ç‚¹æ¸›ç‚¹

**æŠ€ã®åˆ¶é™:**
- åŒä¸€çµ‚æœ«å§¿å‹¢ã®åŠ›é™æ­¢æŠ€: å„ã‚°ãƒ«ãƒ¼ãƒ—1æŠ€ã€åˆè¨ˆæœ€å¤§3æŠ€
- ã‚°ãƒ«ãƒ¼ãƒ—â…¡ãƒ»â…¢æŠ€ã‚’3å›é€£ç¶šå¾Œ: æŒ¯å‹•æŠ€ã‚’çµŒç”±ã—ã¦ã‹ã‚‰æ¬¡ã®åŠ›æŠ€å®Ÿæ–½

**ç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹:**
- åå­—æ‡¸å‚(2ç§’) + ä¸­æ°´å¹³æ”¯æŒ(2ç§’): +0.2ç‚¹
- å€’ç«‹(2ç§’) + åå­—æ‡¸å‚(2ç§’): +0.1ç‚¹

**ç¦æ­¢äº‹é …:**
- ã‚±ãƒ¼ãƒ–ãƒ«ã«ã‚‚ãŸã‚Œã‚‹ãƒ»è¶³ã‚’çµ¡ã‚ã‚‹: æŠ€ã®ä¸èªå®š
- æŒ¯å‹•å€’ç«‹æŠ€(2ç§’)ãªã—: Då¯©åˆ¤ã«ã‚ˆã‚‹æ¸›ç‚¹

**ã‚¸ãƒ¥ãƒ‹ã‚¢è¦å®š:**
- åå­—æ‡¸å‚ãƒ»ä¸­æ°´å¹³æ”¯æŒ: ç¦æ­¢æŠ€""",

    "è·³é¦¬è©³ç´°è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘è·³é¦¬è©³ç´°è¦å‰‡

**é›£åº¦ä¾¡å€¤å¤‰æ›´:**
- å…¨æŠ€ã®é›£åº¦ä¾¡å€¤ãŒ0.4ç‚¹æ¸›å°‘
- æœ€é«˜é›£åº¦: 5.6ç‚¹ï¼ˆå¾“æ¥6.0ç‚¹ã‹ã‚‰ï¼‰

**ç¨®ç›®åˆ¥æ±ºå‹:**
- 2æœ¬ç›®ã«1æœ¬ç›®ã¨åŒã˜æŠ€å®Ÿæ–½: 0ç‚¹
- æŠ€ç•ªå·äº‹å‰ç”³å‘Šå¿…é ˆï¼ˆç•°ãªã‚‹æŠ€å®Ÿæ–½ã§ã‚‚æ¸›ç‚¹ãªã—ï¼‰

**åŠ©èµ°ãƒ»è·³è¶Š:**
- åŠ©èµ°ã‚„ã‚Šç›´ã—: èªã‚ã‚‰ã‚Œã‚‹ãŒ0.3ç‚¹æ¸›ç‚¹
- ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—50ç§’ä¸­ã®è¦å®šè¶…é: 0.3ç‚¹æ¸›ç‚¹

**ç€åœ°ã‚¨ãƒªã‚¢:**
- ç‰‡è¶³ã¾ãŸã¯ç‰‡æ‰‹ãŒã‚¨ãƒªã‚¢å¤–: 0.1ç‚¹æ¸›ç‚¹
- ä¸¡è¶³ãƒ»ä¸¡æ‰‹ãƒ»ä½“ã®ä»–éƒ¨åˆ†ãŒã‚¨ãƒªã‚¢å¤–: 0.3ç‚¹æ¸›ç‚¹

**0ç‚¹ã¨ãªã‚‹ã‚±ãƒ¼ã‚¹:**
1. æ„å›³çš„ãªæ¨ªå‘ãç€åœ°
2. è·³é¦¬å°ã«è§¦ã‚Œãšã«è·³è¶Š
3. ç¦æ­¢è¡Œç‚ºã®å®Ÿæ–½""",

    "å¹³è¡Œæ£’è©³ç´°è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘å¹³è¡Œæ£’è©³ç´°è¦å‰‡

**æ¼”æŠ€é–‹å§‹:**
- ç‰‡è¶³æŒ¯ã‚Šã‚„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®é–‹å§‹: è¨±å¯ã•ã‚Œãªã„

**æŠ€ã®æ–¹å‘åŸå‰‡:**
- å¾Œã‚æŒ¯ã‚Šå€’ç«‹å¾Œ: åŒæ–¹å‘ã¸ã®æŠ€å®Ÿæ–½å¿…é ˆ

**å˜æ£’æŠ€è¦å®š:**
- å˜æ£’æŠ€ã®å€’ç«‹: ä¸¡æ‰‹ã®å¹…ã‚’å¤‰ãˆãšã«å®Ÿæ–½
- å˜æ£’ç¸¦å‘ãå€’ç«‹ã‹ã‚‰ãƒ’ãƒ¼ãƒªãƒ¼ç³»: é›£åº¦èªå®šã•ã‚Œãš
- ãƒ¢ã‚¤ãƒ»å¾Œæ–¹è»Šè¼ªç³»ã§è†æ›²ã’: ä½“ãŒæ°´å¹³ä½ã¾ã§è¨±å¯

**æŠ€ã®åˆ¶é™:**
- ãƒ™ãƒ¼ãƒ¬ç³»: æœ€å¤§1å›ã¾ã§é›£åº¦èªå®š
- å¾Œæ–¹è»Šè¼ªå€’ç«‹æŠ€: æœ€å¤§2å›ã¾ã§é›£åº¦èªå®š  
- æ£’ä¸‹å®™è¿”ã‚Šå€’ç«‹æŠ€: æœ€å¤§1å›ã¾ã§é›£åº¦èªå®š

**ãƒã‚¯ãƒ¼ãƒ„ç³»è¦å®š:**
- å˜æ£’æ¨ªå‘ãå€’ç«‹ã§2ç§’ä»¥ä¸Šåœæ­¢: Då¯©åˆ¤ã¯ä¸èªå®šã€Eå¯©åˆ¤ã¯ä¸­æ¬ ç‚¹

**å‰æŒ¯ã‚Šä¸ŠãŒã‚Šè¦æ±‚:**
- èƒŒä¸­ãŒãƒãƒ¼ã«å¯¾ã—ã¦æ°´å¹³å¿…é ˆ
- æ°´å¹³ã‹ã‚‰45Â°è¶…é€¸è„±: 0.3ç‚¹æ¸›ç‚¹""",

    "é‰„æ£’è©³ç´°è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘é‰„æ£’è©³ç´°è¦å‰‡

**å€’ç«‹é€šéæŠ€:**
- ã‚¢ãƒ‰ãƒ©ãƒ¼ãƒ»ã‚·ãƒ¥ã‚¿ãƒ«ãƒ€ãƒ¼ã§30Â°ï½60Â°é€¸è„±: 0.1ç‚¹æ¸›ç‚¹
- ã‚¯ãƒ¼ã‚¹ãƒˆã§60Â°ï½90Â°é€¸è„±: 0.3ç‚¹æ¸›ç‚¹

**æ‰‹æ”¾ã—æŠ€:**
- ç›´æ¥é€£ç¶šå®Ÿæ–½: 3æŠ€ç›®ã¾ã§èªå®šï¼ˆ2é€£ç¶šã®å ´åˆã®ã¿ï¼‰
- ãƒˆã‚«ãƒã‚§ãƒ•ç³»: æœ€å¤§2å›ã¾ã§å®Ÿæ–½å¯èƒ½
- ã‚³ãƒãƒç³»: æœ€å¤§2å›ã¾ã§å®Ÿæ–½å¯èƒ½

**ç‰¹æ®ŠæŠ€è¦å®š:**
- ãƒ„ã‚©ãƒ»ãƒªãƒŸãƒ³: æœ€åˆã®ã²ã­ã‚Š90Â°è¶…é€¸è„±ã§ä¸èªå®šãƒ»0.5ç‚¹æ¸›ç‚¹
- ãƒ¤ãƒãƒ¯ã‚­: 45Â°è¶…ã®è…°æ›²ãŒã‚Šã§é›£åº¦é™æ ¼

**æ¼”æŠ€é–‹å§‹ãƒ»çµ‚äº†:**
- æŒ¯ã‚Šå‡ºã—: æœ€å¤§3å›ã¾ã§ã€è¶…éã§0.3ç‚¹æ¸›ç‚¹
- å€’ç«‹ã‹ã‚‰æ‡¸å‚ã¸ã®æŒ¯ã‚Šä¸‹ã‚ã—: 0.3ç‚¹æ¸›ç‚¹ï¼ˆä¸­é–“æŒ¯å‹•ï¼‰

**æŠ€ã®åˆ¶é™:**
- ã‚¢ãƒ‰ãƒ©ãƒ¼ç³»: æœ€å¤§3å›ã¾ã§å®Ÿæ–½å¯èƒ½
- åŒä¸€æ‰‹æ”¾ã—æŠ€ã®åå¾©åˆ¶é™ã‚ã‚Š""",

    "è£œè¶³è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘è£œè¶³è¦å‰‡ï¼ˆA3-1ã€A4-eã€A4-fï¼‰

**å§¿å‹¢ã®å®šç¾©ï¼ˆè£œè¶³A3-1ï¼‰:**
- å®Œå…¨ãªå±ˆèº«å§¿å‹¢: è…°ãŒ90Â°ä»¥ä¸Šæ›²ãŒã£ãŸå§¿å‹¢
- ä¼¸èº«å§¿å‹¢ã§è…°ãŒ60Â°ä»¥ä¸Šæ›²ãŒã‚‹: å±ˆèº«å§¿å‹¢ã¨ã¿ãªã™
- å±ˆèº«å§¿å‹¢ã§è†ãŒ60Â°ä»¥ä¸Šæ›²ãŒã‚‹: ã‹ã‹ãˆè¾¼ã¿å§¿å‹¢ã¨ã¿ãªã™
- ã‹ã‹ãˆè¾¼ã¿å§¿å‹¢ã§è†ã®æ›²ãŒã‚ŠãŒ90Â°æœªæº€: æ¬ ç‚¹

**ã‚†ã‹ã®åå­—å€’ç«‹ï¼ˆè£œè¶³A3-1ï¼‰:**
- é ­éƒ¨ãŒåºŠé¢ã‹ã‚‰æœ€ä½30cmä»¥ä¸Šã®é«˜ã•ã«ä½ç½®ã™ã‚‹ã“ã¨

**å¹³è¡Œæ£’ã®å®™è¿”ã‚ŠæŠ€ï¼ˆè£œè¶³A4-eï¼‰:**
- å˜æ£’ç¸¦å‘ãã§æ¡ã‚‹æŠ€: ã‚‚ã†ä¸€æ–¹ã®ãƒãƒ¼ã«ç§»ã™å‰ã«æ˜ç¢ºãªç¸¦å‘ãå§¿å‹¢ã‚’ç¤ºã™å¿…è¦

**ä¸­é–“å§¿å‹¢ã«ã‚ˆã‚‹ä¸èªå®šï¼ˆè£œè¶³A4-fï¼‰:**
- ã¤ã‚Šè¼ªã§ä¾‹ç¤ºã•ã‚Œã‚‹æŠ€: ã€Œãƒ¤ãƒãƒ¯ã‚­ã€ã€Œã‚¸ãƒ§ãƒŠã‚µãƒ³ã€
- ã“ã‚Œã‚‰ã®æŠ€ã§ä¸­é–“å§¿å‹¢ãŒè¦‹ã‚‰ã‚Œã‚‹å ´åˆã€Då¯©åˆ¤ã«ã‚ˆã‚‹ä¸èªå®šã¨ãªã‚‹å¯èƒ½æ€§""",

    "è©³ç´°æŠ€è¡“è¦å‰‡": """ã€2025å¹´ç‰ˆã€‘è©³ç´°æŠ€è¡“è¦å‰‡

**Då¯©åˆ¤ã«ã‚ˆã‚‹æŠ€ã®ä¸èªå®š:**
1. 45Â°ã‚’è¶…ãˆã‚‹è§’åº¦é€¸è„±
2. é™æ­¢æŠ€ã§é™æ­¢ã—ãªã„å ´åˆ
3. è¦å®šã®å§¿å‹¢ã‚’æº€ãŸã•ãªã„å ´åˆ

**å®™è¿”ã‚Šã®é«˜ã•åˆ¤å®š:**
- é«˜ã•ãƒ»å¤§ãã•ä¸è¶³ã®åˆ¤å®šåŸºæº–ã¯æŠ€ã®ç¨®é¡ã¨æœŸå¾…ã•ã‚Œã‚‹è»Œé“ã«ã‚ˆã‚‹
- å°æ¬ ç‚¹ï¼ˆ0.1ï¼‰ã€ä¸­æ¬ ç‚¹ï¼ˆ0.3ï¼‰ã€å¤§æ¬ ç‚¹ï¼ˆ0.5ï¼‰ã®æ®µéšçš„è©•ä¾¡

**æŠ€ã®ã‚«ã‚¦ãƒ³ãƒˆåˆ¶é™:**
- Dã‚¹ã‚³ã‚¢ã«ã¯æœ€é«˜7æŠ€ï¼‹çµ‚æœ«æŠ€ã®è¨ˆ8æŠ€ãŒã‚«ã‚¦ãƒ³ãƒˆ
- åŒä¸€ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰æœ€å¤§4æŠ€ã¾ã§æœ‰åŠ¹ï¼ˆ2025å¹´æ”¹æ­£ï¼‰

**ç€åœ°ãƒãƒƒãƒˆæ§‹æˆï¼ˆã¤ã‚Šè¼ªãƒ»é‰„æ£’ï¼‰:**
- FIGè¦å®šã«ã‚ˆã‚Šé©åˆ‡ãªåšã•ã¨æè³ªã®ç€åœ°ãƒãƒƒãƒˆãŒå¿…é ˆ
- å®‰å…¨æ€§ç¢ºä¿ã®ãŸã‚è¦å®šã‚µã‚¤ã‚ºä»¥ä¸Šã®ãƒãƒƒãƒˆé…ç½®

**ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ™‚é–“:**
- å›£ä½“ç·åˆäºˆé¸ãƒ»æ±ºå‹: å„ç¨®ç›®è¦å®šæ™‚é–“ã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
- ç¨®ç›®åˆ¥: è·³é¦¬50ç§’ã€ãã®ä»–ç¨®ç›®ã¯è¦å®šã«ã‚ˆã‚‹

**é‰„æ£’æ‰‹æ”¾ã—æŠ€ã®æº–å‚™:**
- è»Šè¼ªå¤‰å½¢ãŒæº–å‚™å±€é¢ã®å ´åˆã€å€’ç«‹é€šéãªã—ã§ã‚‚æ¸›ç‚¹ã•ã‚Œãªã„æ¡ä»¶ã‚ã‚Š"""
}

# æ±ç”¨çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ï¼ˆå¾“æ¥ã®æ©Ÿèƒ½ã‚’ç¶­æŒï¼‰
GYMNASTICS_KNOWLEDGE = {
    "ndæ¸›ç‚¹": """NDï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ãƒ‡ã‚£ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ï¼‰æ¸›ç‚¹ï¼š

ã€ä¸»ãªNDæ¸›ç‚¹ã€‘
- æ¼”æŠ€æ™‚é–“è¶…é/ä¸è¶³: 0.1ã€œ0.3ç‚¹
- ãƒ©ã‚¤ãƒ³æ¸›ç‚¹: 0.1ç‚¹/å›ï¼ˆç‰‡è¶³ãƒ»ä¸¡è¶³ã¨ã‚‚ï¼‰
- æœè£…é•å: 0.3ç‚¹
- ã‚³ãƒ¼ãƒã®é•åè¡Œç‚º: 0.5ç‚¹
- å™¨æ¢°ã®ä¸é©åˆ‡ãªä½¿ç”¨: 0.5ç‚¹

ã“ã‚Œã‚‰ã¯æ¼”æŠ€å®Ÿæ–½ç‚¹ã¨ã¯åˆ¥ã«æ¸›ç‚¹ã•ã‚Œã¾ã™ã€‚""",
    
    "æ¼”æŠ€æ§‹æˆåˆ†æ": """æ¼”æŠ€æ§‹æˆåˆ†æã®ãƒã‚¤ãƒ³ãƒˆï¼š

ã€2025å¹´ç‰ˆ Dã‚¹ã‚³ã‚¢ã®æ§‹æˆè¦ç´ ã€‘
1. é›£åº¦ç‚¹åˆè¨ˆï¼ˆæœ€é«˜7æŠ€+çµ‚æœ«æŠ€=è¨ˆ8æŠ€ã€è·³é¦¬ã¯1æŠ€ï¼‰
2. ã‚°ãƒ«ãƒ¼ãƒ—ãƒœãƒ¼ãƒŠã‚¹ï¼ˆDé›£åº¦ä»¥ä¸Š0.5ç‚¹ã€A-Cé›£åº¦0.3ç‚¹ï¼‰
3. é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹ï¼ˆCVï¼‰
4. çµ‚æœ«æŠ€ã‚°ãƒ«ãƒ¼ãƒ—åŠ ç‚¹ï¼ˆè©²å½“ç¨®ç›®ã®ã¿ï¼‰

ã€æœ€é©åŒ–ã®ã‚³ãƒ„ã€‘
- é«˜é›£åº¦æŠ€ã‚’åŠ¹ç‡çš„ã«é…ç½®
- é€£ç¶šæŠ€ã§åŠ ç‚¹ã‚’ç‹™ã†
- ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ã‚’ç¢ºå®Ÿã«æº€ãŸã™
- ä½“åŠ›é…åˆ†ã‚’è€ƒæ…®ã—ãŸæ§‹æˆ"""
}

@app.get("/")
def read_root():
    return {"Hello": "World", "Port": os.getenv("PORT", "8080")}

@app.get("/health")
def health():
    return {"status": "ok"}

def load_knowledge_base():
    """çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿"""
    knowledge = {}
    knowledge_files = [
        "data/d_score_master_knowledge.md",
        "data/rulebook_ja_summary.md", 
        "data/apparatus_details.md",
        "data/difficulty_calculation_system.md"
    ]
    
    for file_path in knowledge_files:
        try:
            if os.path.exists(file_path):
                with open(file_path, 'r', encoding='utf-8') as f:
                    knowledge[file_path] = f.read()
        except Exception as e:
            print(f"Warning: Could not load {file_path}: {e}")
    
    return knowledge

def analyze_routine_and_suggest_improvements(message):
    """æ¼”æŠ€æ§‹æˆåˆ†æã‚’å—ã‘ã¦æ”¹å–„ææ¡ˆã‚’ç”Ÿæˆ - é«˜åº¦ç‰ˆ"""
    
    # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿
    knowledge_base = load_knowledge_base()
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    import re
    
    # ã‚ˆã‚Šè©³ç´°ãªãƒ‡ãƒ¼ã‚¿æŠ½å‡º
    d_score_match = re.search(r'Dã‚¹ã‚³ã‚¢:\s*([\d.]+)', message)
    difficulty_match = re.search(r'é›£åº¦ç‚¹:\s*([\d.]+)', message)
    group_match = re.search(r'ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚.*?(\d+)/(\d+)', message)
    connection_match = re.search(r'é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹:\s*([\d.]+)', message)
    skill_count_match = re.search(r'æŠ€æ•°:\s*(\d+)', message)
    apparatus_match = re.search(r'- ç¨®ç›®:\s*([A-Z]{2})', message)
    nd_match = re.search(r'NDæ¸›ç‚¹:\s*(-?[\d.]+)', message)
    missing_groups_match = re.search(r'ä¸è¶³ã‚°ãƒ«ãƒ¼ãƒ—:\s*(.+)', message)
    
    # æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿
    d_score = float(d_score_match.group(1)) if d_score_match else 0.0
    difficulty_value = float(difficulty_match.group(1)) if difficulty_match else 0.0
    fulfilled_groups = int(group_match.group(1)) if group_match else 0
    required_groups = int(group_match.group(2)) if group_match else 4
    connection_bonus = float(connection_match.group(1)) if connection_match else 0.0
    skill_count = int(skill_count_match.group(1)) if skill_count_match else 0
    apparatus = apparatus_match.group(1) if apparatus_match else None
    nd_deduction = float(nd_match.group(1)) if nd_match else 0.0
    missing_groups_text = missing_groups_match.group(1) if missing_groups_match else ""
    
    # ç¨®ç›®ãŒæ¤œå‡ºã§ããªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    if not apparatus:
        return {
            "response": "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¨®ç›®æƒ…å ±ã‚’æ­£ã—ãèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚åˆ†æçµæœã«ã€Œ- ç¨®ç›®: [ç¨®ç›®ã‚³ãƒ¼ãƒ‰]ã€ã®å½¢å¼ã§ç¨®ç›®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã”ç¢ºèªãã ã•ã„ã€‚",
            "conversation_id": "error_001"
        }
    
    # æœ‰åŠ¹ãªç¨®ç›®ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
    valid_apparatus = ["FX", "PH", "SR", "VT", "PB", "HB"]
    if apparatus not in valid_apparatus:
        return {
            "response": f"ç¨®ç›®ã‚³ãƒ¼ãƒ‰ã€Œ{apparatus}ã€ã¯èªè­˜ã§ãã¾ã›ã‚“ã€‚æœ‰åŠ¹ãªç¨®ç›®ã‚³ãƒ¼ãƒ‰ï¼šFXï¼ˆåºŠï¼‰ã€PHï¼ˆã‚ã‚“é¦¬ï¼‰ã€SRï¼ˆã¤ã‚Šè¼ªï¼‰ã€VTï¼ˆè·³é¦¬ï¼‰ã€PBï¼ˆå¹³è¡Œæ£’ï¼‰ã€HBï¼ˆé‰„æ£’ï¼‰",
            "conversation_id": "error_002"
        }
    
    # é«˜åº¦ãªæ§‹æˆåˆ†æã®å®Ÿæ–½
    analysis_result = perform_advanced_analysis(
        apparatus, d_score, difficulty_value, fulfilled_groups, required_groups,
        connection_bonus, skill_count, nd_deduction, missing_groups_text, knowledge_base
    )
    
    return {
        "response": analysis_result,
        "conversation_id": "advanced_analysis_001"
    }

def perform_advanced_analysis(apparatus, d_score, difficulty_value, fulfilled_groups, 
                            required_groups, connection_bonus, skill_count, nd_deduction,
                            missing_groups_text, knowledge_base):
    """é«˜åº¦ãªæ¼”æŠ€æ§‹æˆåˆ†æã‚’å®Ÿè¡Œ"""
    
    # è·³é¦¬ã®ç‰¹åˆ¥å‡¦ç†
    if apparatus == "VT":
        return generate_vault_analysis(d_score, skill_count)
    
    # åˆ†æçµæœã®æ§‹ç¯‰
    analysis_sections = []
    
    # 1. ç¾åœ¨ã®æ§‹æˆè©•ä¾¡
    current_status = generate_current_status_analysis(
        apparatus, d_score, difficulty_value, skill_count, fulfilled_groups, required_groups
    )
    analysis_sections.append(current_status)
    
    # 2. é‡è¦ãªå•é¡Œç‚¹ã®ç‰¹å®š
    critical_issues = identify_critical_issues(
        apparatus, fulfilled_groups, required_groups, nd_deduction, skill_count, connection_bonus
    )
    if critical_issues:
        analysis_sections.append(f"ğŸš¨ **ç·Šæ€¥æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ**\n{critical_issues}")
    
    # 3. ç¨®ç›®åˆ¥å°‚é–€ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    specialized_advice = generate_apparatus_specific_advice(
        apparatus, fulfilled_groups, required_groups, connection_bonus, knowledge_base
    )
    analysis_sections.append(specialized_advice)
    
    # 4. NDæ¸›ç‚¹ã®è©³ç´°èª¬æ˜
    if nd_deduction > 0:
        nd_explanation = explain_nd_deductions(nd_deduction, apparatus, knowledge_base)
        analysis_sections.append(nd_explanation)
    
    # 5. å…·ä½“çš„æ”¹å–„æˆ¦ç•¥
    improvement_strategy = generate_improvement_strategy(
        apparatus, d_score, difficulty_value, skill_count, fulfilled_groups, 
        required_groups, connection_bonus, knowledge_base
    )
    analysis_sections.append(improvement_strategy)
    
    # 6. è¿½åŠ è³ªå•ã¸ã®å¯¾å¿œ
    analysis_sections.append("ğŸ’¬ **ã•ã‚‰ã«è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¸**\nå…·ä½“çš„ãªæŠ€ã®æ¨å¥¨ã€ç·´ç¿’æ–¹æ³•ã€ãƒ«ãƒ¼ãƒ«è©³ç´°ãªã©ã”è³ªå•ãã ã•ã„ï¼")
    
    return "\n\n".join(analysis_sections)

def generate_vault_analysis(d_score, skill_count):
    """è·³é¦¬å°‚ç”¨åˆ†æ"""
    if skill_count == 0:
        return "**è·³é¦¬æŠ€ã‚’é¸æŠã—ã¦ãã ã•ã„**\n\nä½•ã‹ã”è³ªå•ãŒã‚ã‚Œã°ãŠç­”ãˆã—ã¾ã™ã€‚"
    else:
        return f"""**ğŸ¤¸â€â™‚ï¸ è·³é¦¬åˆ†æçµæœ**

**ç¾åœ¨ã®Dã‚¹ã‚³ã‚¢: {d_score:.1f}ç‚¹**

è·³é¦¬ã§ã¯1æœ¬ã¾ãŸã¯2æœ¬ã®æŠ€ã§Dã‚¹ã‚³ã‚¢ãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚
ã‚ˆã‚Šé«˜é›£åº¦ã®æŠ€ã¸ã®æŒ‘æˆ¦ã§å¾—ç‚¹å‘ä¸ŠãŒå¯èƒ½ã§ã™ã€‚

ä½•ã‹ã”è³ªå•ãŒã‚ã‚Œã°ãŠç­”ãˆã—ã¾ã™ã€‚"""

def generate_current_status_analysis(apparatus, d_score, difficulty_value, skill_count, fulfilled_groups, required_groups):
    """ç¾åœ¨ã®æ§‹æˆçŠ¶æ³åˆ†æ"""
    apparatus_names = {"FX": "åºŠé‹å‹•", "PH": "ã‚ã‚“é¦¬", "SR": "ã¤ã‚Šè¼ª", "PB": "å¹³è¡Œæ£’", "HB": "é‰„æ£’"}
    apparatus_name = apparatus_names.get(apparatus, apparatus)
    
    avg_difficulty = difficulty_value / skill_count if skill_count > 0 else 0
    group_completion = (fulfilled_groups / required_groups) * 100 if required_groups > 0 else 100
    
    status_emoji = "âœ…" if group_completion >= 100 and skill_count >= 6 else "âš ï¸"
    
    return f"""**{status_emoji} {apparatus_name}æ§‹æˆåˆ†æçµæœ**

ğŸ“Š **åŸºæœ¬ãƒ‡ãƒ¼ã‚¿**
â€¢ Dã‚¹ã‚³ã‚¢: {d_score:.1f}ç‚¹
â€¢ æŠ€æ•°: {skill_count}æŠ€
â€¢ å¹³å‡é›£åº¦: {avg_difficulty:.2f}ç‚¹
â€¢ ã‚°ãƒ«ãƒ¼ãƒ—é”æˆåº¦: {fulfilled_groups}/{required_groups} ({group_completion:.0f}%)"""

def identify_critical_issues(apparatus, fulfilled_groups, required_groups, nd_deduction, skill_count, connection_bonus):
    """é‡è¦ãªå•é¡Œç‚¹ã‚’ç‰¹å®š"""
    issues = []
    
    # ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ä¸è¶³ã®æ·±åˆ»åº¦è©•ä¾¡
    if fulfilled_groups < required_groups:
        missing = required_groups - fulfilled_groups
        severity = "â›” æ¥µã‚ã¦é‡è¦" if missing >= 2 else "ğŸ”´ é‡è¦"
        issues.append(f"{severity}: {missing}ã‚°ãƒ«ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™")
    
    # æŠ€æ•°ä¸è¶³ãƒã‚§ãƒƒã‚¯
    if skill_count < 6:
        issues.append("ğŸ”´ é‡è¦: æŠ€æ•°ãŒæ¥µç«¯ã«å°‘ãªã„ã§ã™ï¼ˆæœ€ä½6æŠ€æ¨å¥¨ï¼‰")
    
    # NDæ¸›ç‚¹ã®æ·±åˆ»åº¦
    if nd_deduction > 0.5:
        issues.append(f"â›” æ¥µã‚ã¦é‡è¦: NDæ¸›ç‚¹ãŒ-{nd_deduction:.1f}ç‚¹ã¨é«˜é¡ã§ã™")
    elif nd_deduction > 0:
        issues.append(f"ğŸ”´ é‡è¦: NDæ¸›ç‚¹-{nd_deduction:.1f}ç‚¹ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™")
    
    # é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹æœªæ´»ç”¨
    if apparatus in ["FX", "HB"] and connection_bonus == 0:
        issues.append("ğŸŸ¡ æ”¹å–„ä½™åœ°: é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹ãŒæœªæ´»ç”¨ã§ã™")
    
    return "\n".join([f"â€¢ {issue}" for issue in issues]) if issues else ""

def generate_apparatus_specific_advice(apparatus, fulfilled_groups, required_groups, connection_bonus, knowledge_base):
    """ç¨®ç›®åˆ¥å°‚é–€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆçŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ´»ç”¨ç‰ˆï¼‰"""
    apparatus_names = {"FX": "åºŠé‹å‹•", "PH": "ã‚ã‚“é¦¬", "SR": "ã¤ã‚Šè¼ª", "PB": "å¹³è¡Œæ£’", "HB": "é‰„æ£’"}
    apparatus_name = apparatus_names.get(apparatus, apparatus)
    
    advice_sections = [f"ğŸ¯ **{apparatus_name}å°‚é–€ã‚¢ãƒ‰ãƒã‚¤ã‚¹**"]
    
    # åŸºæœ¬çš„ãªç¨®ç›®ç‰¹æ€§ã‚’çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æŠ½å‡º
    if apparatus in APPARATUS_KNOWLEDGE:
        apparatus_data = APPARATUS_KNOWLEDGE[apparatus]
        advice_sections.append(apparatus_data["specific_advice"])
        
        # ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ã®è©³ç´°èª¬æ˜
        if fulfilled_groups < required_groups:
            missing = required_groups - fulfilled_groups
            advice_sections.append(f"""
ğŸš¨ **ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚åˆ†æ**
â€¢ ä¸è¶³: {missing}ã‚°ãƒ«ãƒ¼ãƒ—
â€¢ å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ç‰¹å¾´:""")
            
            for group, description in apparatus_data["groups"].items():
                advice_sections.append(f"  â€¢ ã‚°ãƒ«ãƒ¼ãƒ—{group}: {description}")
    
    # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é«˜åº¦ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
    advanced_advice = extract_advanced_apparatus_advice(apparatus, knowledge_base)
    if advanced_advice:
        advice_sections.append(advanced_advice)
    
    return "\n".join(advice_sections)

def extract_advanced_apparatus_advice(apparatus, knowledge_base):
    """çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é«˜åº¦ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æŠ½å‡º"""
    apparatus_keywords = {
        "FX": ["åºŠé‹å‹•", "floor", "ã‚¿ãƒ³ãƒ–ãƒªãƒ³ã‚°", "é€£ç¶šæŠ€"],
        "PH": ["ã‚ã‚“é¦¬", "pommel", "æ—‹å›", "ã‚·ã‚¶ãƒ¼ã‚¹"],
        "SR": ["ã¤ã‚Šè¼ª", "rings", "é™æ­¢æŠ€", "ç­‹åŠ›"],
        "PB": ["å¹³è¡Œæ£’", "parallel", "æ”¯æŒ", "æŒ¯å‹•"],
        "HB": ["é‰„æ£’", "horizontal", "æ‰‹æ”¾ã—", "å¤§è»Šè¼ª"]
    }
    
    if apparatus not in apparatus_keywords:
        return ""
    
    keywords = apparatus_keywords[apparatus]
    advice_parts = []
    
    # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é–¢é€£æƒ…å ±ã‚’æ¤œç´¢
    for file_path, content in knowledge_base.items():
        if any(keyword in content for keyword in keywords):
            # ç¨®ç›®é–¢é€£ã®é‡è¦æƒ…å ±ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
            lines = content.split('\n')
            for i, line in enumerate(lines):
                if any(keyword in line for keyword in keywords):
                    # é–¢é€£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ•°è¡Œå–å¾—
                    section_lines = lines[max(0, i-1):i+3]
                    relevant_text = '\n'.join(section_lines).strip()
                    if len(relevant_text) > 20 and relevant_text not in advice_parts:
                        advice_parts.append(relevant_text[:200] + "..." if len(relevant_text) > 200 else relevant_text)
                        break  # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰1ã¤ãšã¤
    
    if advice_parts:
        return f"ğŸ“š **å…¬å¼ãƒ«ãƒ¼ãƒ«æº–æ‹ ã‚¢ãƒ‰ãƒã‚¤ã‚¹**\n" + "\n\n".join(advice_parts[:2])  # æœ€å¤§2ã¤ã¾ã§
    
    return ""

def explain_nd_deductions(nd_deduction, apparatus, knowledge_base):
    """NDæ¸›ç‚¹ã®è©³ç´°èª¬æ˜"""
    explanation = f"âš ï¸ **NDæ¸›ç‚¹è©³ç´°åˆ†æ (-{nd_deduction:.1f}ç‚¹)**\n"
    
    # ä¸€èˆ¬çš„ãªNDæ¸›ç‚¹è¦å› 
    common_nd_causes = {
        "FX": ["ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ä¸è¶³", "çµ‚æœ«æŠ€ä»¥å¤–ã§ã®ç€åœ°", "æ™‚é–“è¶…éãƒ»ä¸è¶³"],
        "PH": ["ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ä¸è¶³", "æ—‹å›åœæ­¢", "ä¸‹ã‚ŠæŠ€ãªã—"],
        "SR": ["ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ä¸è¶³", "é™æ­¢æŠ€ä¸è¶³", "ä¸‹ã‚ŠæŠ€ãªã—"],
        "PB": ["ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ä¸è¶³", "ä¸‹ã‚ŠæŠ€ãªã—"],
        "HB": ["ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ä¸è¶³", "æ‰‹æ”¾ã—æŠ€ä¸è¶³", "ä¸‹ã‚ŠæŠ€ãªã—"]
    }
    
    if apparatus in common_nd_causes:
        explanation += "**ä¸»ãªæ¸›ç‚¹è¦å› ã®å¯èƒ½æ€§:**\n"
        for cause in common_nd_causes[apparatus]:
            explanation += f"â€¢ {cause}\n"
    
    # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰NDæ¸›ç‚¹ãƒ«ãƒ¼ãƒ«ã‚’æ¤œç´¢
    nd_rules = search_nd_rules_in_knowledge_base(apparatus, knowledge_base)
    if nd_rules:
        explanation += f"\n**å…¬å¼ãƒ«ãƒ¼ãƒ«:**\n{nd_rules}"
    
    explanation += f"\nğŸ’¡ **æ”¹å–„ã®ãƒ’ãƒ³ãƒˆ:** æ§‹æˆã‚’è¦‹ç›´ã—ã¦ä¸Šè¨˜è¦å› ã‚’è§£æ¶ˆã™ã‚Œã°{nd_deduction:.1f}ç‚¹ã®å›å¾©ãŒæœŸå¾…ã§ãã¾ã™ã€‚"
    
    return explanation

def search_nd_rules_in_knowledge_base(apparatus, knowledge_base):
    """çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰NDæ¸›ç‚¹ãƒ«ãƒ¼ãƒ«ã‚’æ¤œç´¢"""
    search_keywords = ["ND", "æ¸›ç‚¹", "ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚", "çµ‚æœ«æŠ€"]
    
    for file_path, content in knowledge_base.items():
        if "nd" in file_path.lower() or "æ¸›ç‚¹" in content:
            lines = content.split('\n')
            for i, line in enumerate(lines):
                if any(keyword in line for keyword in search_keywords):
                    # é–¢é€£ã™ã‚‹æ•°è¡Œã‚’æŠ½å‡º
                    section = '\n'.join(lines[max(0, i-1):i+3]).strip()
                    if len(section) > 10:
                        return section[:300] + "..." if len(section) > 300 else section
    
    return ""

def generate_improvement_strategy(apparatus, d_score, difficulty_value, skill_count, 
                                fulfilled_groups, required_groups, connection_bonus, knowledge_base):
    """å…·ä½“çš„æ”¹å–„æˆ¦ç•¥ã®ç”Ÿæˆ"""
    strategy = "ğŸš€ **æ”¹å–„æˆ¦ç•¥**\n"
    
    improvements = []
    potential_gain = 0
    
    # 1. ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚æ”¹å–„
    if fulfilled_groups < required_groups:
        missing = required_groups - fulfilled_groups
        potential_gain += missing * 0.5  # ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ãƒœãƒ¼ãƒŠã‚¹
        improvements.append(f"âœ… å„ªå…ˆåº¦1: {missing}ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ  (+{missing * 0.5:.1f}ç‚¹æœŸå¾…)")
    
    # 2. æŠ€æ•°è¿½åŠ 
    if skill_count < 8:
        additional_skills = min(8 - skill_count, 2)  # æœ€å¤§2æŠ€è¿½åŠ ã‚’æ¨å¥¨
        potential_gain += additional_skills * 0.3  # å¹³å‡é›£åº¦æƒ³å®š
        improvements.append(f"âœ… å„ªå…ˆåº¦2: {additional_skills}æŠ€è¿½åŠ  (+{additional_skills * 0.3:.1f}ç‚¹æœŸå¾…)")
    
    # 3. é€£ç¶šæŠ€ãƒœãƒ¼ãƒŠã‚¹
    if apparatus in ["FX", "HB"] and connection_bonus < 0.2:
        bonus_potential = 0.2 - connection_bonus
        potential_gain += bonus_potential
        improvements.append(f"âœ… å„ªå…ˆåº¦3: é€£ç¶šæŠ€å¼·åŒ– (+{bonus_potential:.1f}ç‚¹æœŸå¾…)")
    
    # 4. é›£åº¦å‘ä¸Š
    avg_difficulty = difficulty_value / skill_count if skill_count > 0 else 0
    if avg_difficulty < 0.4:
        improvements.append("âœ… é•·æœŸç›®æ¨™: æŠ€ã®é›£åº¦å‘ä¸Š (+0.2ï½0.5ç‚¹æœŸå¾…)")
        potential_gain += 0.3
    
    if improvements:
        strategy += "\n".join(improvements)
        strategy += f"\n\nğŸ“ˆ **æœŸå¾…åŠ¹æœ:** æœ€å¤§ +{potential_gain:.1f}ç‚¹ â†’ ç›®æ¨™Dã‚¹ã‚³ã‚¢ {d_score + potential_gain:.1f}ç‚¹"
    else:
        strategy += "ğŸŒŸ ç¾åœ¨ã®æ§‹æˆã¯æ—¢ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼\næ›´ãªã‚‹å‘ä¸Šã«ã¯é«˜é›£åº¦æŠ€ã¸ã®æŒ‘æˆ¦ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚"
    
    return strategy

def get_apparatus_specific_advice(apparatus, fulfilled_groups, required_groups):
    """å¾“æ¥ã®ç¨®ç›®åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰"""
    if apparatus not in APPARATUS_KNOWLEDGE:
        return ""
    
    apparatus_data = APPARATUS_KNOWLEDGE[apparatus]
    advice = apparatus_data["specific_advice"]
    
    # ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ã®è©³ç´°åˆ†æ
    if fulfilled_groups < required_groups:
        missing_groups = required_groups - fulfilled_groups
        group_info = apparatus_data["groups"]
        
        advice += f"\n\nğŸ¯ **ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚ã®è©³ç´°**\n"
        advice += f"ãƒ»ç¾åœ¨{fulfilled_groups}/{required_groups}ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æº€ãŸã—ã¦ã„ã¾ã™\n"
        advice += f"ãƒ»ä¸è¶³ã—ã¦ã„ã‚‹{missing_groups}ã‚°ãƒ«ãƒ¼ãƒ—ã®æŠ€ã‚’è¿½åŠ ã—ã¦ãã ã•ã„\n\n"
        
        # å„ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¬æ˜ã‚’è¿½åŠ 
        advice += "**å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ç‰¹å¾´**:\n"
        for group, description in group_info.items():
            advice += f"ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—{group}: {description}\n"
    
    # é€£ç¶šæŠ€ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ 
    if "connection_rules" in apparatus_data:
        advice += f"\n\nğŸ“‹ **é€£ç¶šæŠ€ãƒ«ãƒ¼ãƒ«**\n{apparatus_data['connection_rules']}"
    
    return advice

@app.post("/chat/message")
async def chat(data: dict):
    try:
        message = data.get("message", "")
        if not message.strip():
            return {"response": "è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "conversation_id": "error_empty"}
        
        # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’æŠ½å‡º
        context = {
            "apparatus": data.get("apparatus"),
            "d_score": data.get("d_score"),
            "skill_count": data.get("skill_count"),
            "group_fulfillment": data.get("group_fulfillment")
        }
        
        # ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆAIã§å›ç­”ã‚’ç”Ÿæˆ
        logger.info(f"Processing question: {message[:100]}...")
        response = await intelligent_ai.get_intelligent_response(message, context)
        
        return {
            "response": response,
            "conversation_id": "intelligent_ai_001"
        }
        
    except Exception as e:
        logger.error(f"Chat error: {e}")
        # æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return {
            "response": """ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ã«ã‚µãƒ¼ãƒ“ã‚¹ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

ä½“æ“ç«¶æŠ€ã«ã¤ã„ã¦åŸºæœ¬çš„ãªã”è³ªå•ã«ã¯ãŠç­”ãˆã§ãã¾ã™ï¼š
â€¢ å„ç¨®ç›®ã®æŠ€è¡“ã¨ç‰¹å¾´
â€¢ æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ ã¨ãƒ«ãƒ¼ãƒ«
â€¢ æ¼”æŠ€æ§‹æˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹

ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚""",
            "conversation_id": "error_fallback"
        }

# å¾“æ¥ã®æ©Ÿèƒ½ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ä¿æŒ
@app.post("/chat/message/legacy")
def chat_legacy(data: dict):
    
    # ç¨®ç›®åˆ¥ã®çŸ¥è­˜æ¤œç´¢
    apparatus_keywords = {
        "ã‚ã‚“é¦¬": "PH", "ph": "PH", "pommel": "PH",
        "ã¤ã‚Šè¼ª": "SR", "sr": "SR", "rings": "SR", "é™æ­¢æŠ€": "SR",
        "è·³é¦¬": "VT", "vt": "VT", "vault": "VT",
        "å¹³è¡Œæ£’": "PB", "pb": "PB", "parallel": "PB",
        "é‰„æ£’": "HB", "hb": "HB", "horizontal": "HB", "æ‰‹æ”¾ã—": "HB",
        "åºŠ": "FX", "fx": "FX", "floor": "FX", "ã‚†ã‹": "FX"
    }
    
    # ç¨®ç›®ç‰¹æœ‰ã®è³ªå•ã¸ã®å¯¾å¿œ
    for keyword, apparatus in apparatus_keywords.items():
        if keyword in message:
            if apparatus in APPARATUS_KNOWLEDGE:
                apparatus_data = APPARATUS_KNOWLEDGE[apparatus]
                response = f"""**{apparatus_data['name']}**ã«ã¤ã„ã¦è©³ã—ããŠç­”ãˆã—ã¾ã™ï¼\n\n"""
                
                # é€£ç¶šæŠ€ã‚„ãƒ«ãƒ¼ãƒ«ã«ã¤ã„ã¦ã®è³ªå•
                if any(word in message for word in ["é€£ç¶šæŠ€", "ãƒ«ãƒ¼ãƒ«", "æ§‹æˆ", "è¦æ±‚"]):
                    response += apparatus_data.get("connection_rules", "")
                    response += f"\n\n{apparatus_data['specific_advice']}"
                
                # ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¤ã„ã¦ã®è³ªå•  
                elif "ã‚°ãƒ«ãƒ¼ãƒ—" in message:
                    response += "**ã‚°ãƒ«ãƒ¼ãƒ—æ§‹æˆ**:\n"
                    for group, desc in apparatus_data["groups"].items():
                        response += f"ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—{group}: {desc}\n"
                    response += f"\n{apparatus_data['specific_advice']}"
                
                # ä¸€èˆ¬çš„ãªè³ªå•
                else:
                    response += apparatus_data["specific_advice"]
                    if "connection_rules" in apparatus_data:
                        response += f"\n\n{apparatus_data['connection_rules']}"
                
                return {
                    "response": response,
                    "conversation_id": "apparatus_001"
                }
    
    # æ¡ç‚¹è¦å‰‡ã®è©³ç´°æ¤œç´¢
    scoring_keywords = {
        "çŸ­ã„æ¼”æŠ€": "çŸ­ã„æ¼”æŠ€ã®æ¸›ç‚¹",
        "æŠ€æ•°": "çŸ­ã„æ¼”æŠ€ã®æ¸›ç‚¹", 
        "ndæ¸›ç‚¹": "çŸ­ã„æ¼”æŠ€ã®æ¸›ç‚¹",
        "ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«": "çŸ­ã„æ¼”æŠ€ã®æ¸›ç‚¹",
        "è§’åº¦": "è§’åº¦é€¸è„±æ¸›ç‚¹",
        "é€¸è„±": "è§’åº¦é€¸è„±æ¸›ç‚¹",
        "é™æ­¢æŠ€": "é™æ­¢æŠ€è¦æ±‚",
        "2ç§’": "é™æ­¢æŠ€è¦æ±‚",
        "é™æ­¢æ™‚é–“": "é™æ­¢æŠ€è¦æ±‚",
        "ç€åœ°": "ç€åœ°æ¸›ç‚¹",
        "ãƒ©ã‚¤ãƒ³": "ç€åœ°æ¸›ç‚¹",
        "ã‚°ãƒ«ãƒ¼ãƒ—": "ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚",
        "ä¾¡å€¤ç‚¹": "ã‚°ãƒ«ãƒ¼ãƒ—è¦æ±‚",
        "æŠ€è¡“çš„": "æŠ€è¡“çš„æ¸›ç‚¹",
        "å§¿å‹¢": "æŠ€è¡“çš„æ¸›ç‚¹",
        "ä¸­é–“æŒ¯å‹•": "æŠ€è¡“çš„æ¸›ç‚¹",
        "æœè£…": "ç«¶æŠ€å‚åŠ è€…è¦å‰‡",
        "ã‚³ãƒ¼ãƒ": "ç«¶æŠ€å‚åŠ è€…è¦å‰‡",
        "ã‚°ãƒªãƒ¼ãƒ³ãƒ©ã‚¤ãƒˆ": "ç«¶æŠ€å‚åŠ è€…è¦å‰‡",
        "æ¼”æŠ€é–‹å§‹": "ç«¶æŠ€å‚åŠ è€…è¦å‰‡",
        "è½ä¸‹": "ç«¶æŠ€å‚åŠ è€…è¦å‰‡",
        "å¯©åˆ¤": "å¯©åˆ¤å›£æ§‹æˆ",
        "æ–°æŠ€": "å¯©åˆ¤å›£æ§‹æˆ",
        "é•å": "é•åè¡Œç‚ºã¨ç½°å‰‡",
        "éœ§å¹ã": "é•åè¡Œç‚ºã¨ç½°å‰‡",
        "ãƒ—ãƒ­ãƒ†ã‚¯ã‚¿ãƒ¼": "é•åè¡Œç‚ºã¨ç½°å‰‡",
        "åºŠé‹å‹•": "åºŠé‹å‹•è©³ç´°è¦å‰‡",
        "ã‚†ã‹": "åºŠé‹å‹•è©³ç´°è¦å‰‡",
        "ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆ": "åºŠé‹å‹•è©³ç´°è¦å‰‡",
        "ç‰‡è¶³å¹³å‡": "åºŠé‹å‹•è©³ç´°è¦å‰‡",
        "70ç§’": "åºŠé‹å‹•è©³ç´°è¦å‰‡",
        "ã‚ã‚“é¦¬": "ã‚ã‚“é¦¬è©³ç´°è¦å‰‡",
        "æ—‹å›": "ã‚ã‚“é¦¬è©³ç´°è¦å‰‡",
        "äº¤å·®æŠ€": "ã‚ã‚“é¦¬è©³ç´°è¦å‰‡",
        "ã‚·ãƒ§ãƒ¼ãƒ³": "ã‚ã‚“é¦¬è©³ç´°è¦å‰‡",
        "ãƒ™ã‚ºã‚´": "ã‚ã‚“é¦¬è©³ç´°è¦å‰‡",
        "ã¤ã‚Šè¼ª": "ã¤ã‚Šè¼ªè©³ç´°è¦å‰‡",
        "åå­—æ‡¸å‚": "ã¤ã‚Šè¼ªè©³ç´°è¦å‰‡",
        "ä¸­æ°´å¹³": "ã¤ã‚Šè¼ªè©³ç´°è¦å‰‡",
        "è·³é¦¬": "è·³é¦¬è©³ç´°è¦å‰‡",
        "åŠ©èµ°": "è·³é¦¬è©³ç´°è¦å‰‡",
        "ç¨®ç›®åˆ¥æ±ºå‹": "è·³é¦¬è©³ç´°è¦å‰‡",
        "å¹³è¡Œæ£’": "å¹³è¡Œæ£’è©³ç´°è¦å‰‡",
        "å˜æ£’": "å¹³è¡Œæ£’è©³ç´°è¦å‰‡",
        "ãƒ’ãƒ¼ãƒªãƒ¼": "å¹³è¡Œæ£’è©³ç´°è¦å‰‡",
        "ãƒ™ãƒ¼ãƒ¬": "å¹³è¡Œæ£’è©³ç´°è¦å‰‡",
        "ãƒã‚¯ãƒ¼ãƒ„": "å¹³è¡Œæ£’è©³ç´°è¦å‰‡",
        "é‰„æ£’": "é‰„æ£’è©³ç´°è¦å‰‡",
        "æ‰‹æ”¾ã—": "é‰„æ£’è©³ç´°è¦å‰‡",
        "ã‚¢ãƒ‰ãƒ©ãƒ¼": "é‰„æ£’è©³ç´°è¦å‰‡",
        "ãƒˆã‚«ãƒã‚§ãƒ•": "é‰„æ£’è©³ç´°è¦å‰‡",
        "ã‚³ãƒãƒ": "é‰„æ£’è©³ç´°è¦å‰‡",
        "è£œè¶³": "è£œè¶³è¦å‰‡",
        "å±ˆèº«å§¿å‹¢": "è£œè¶³è¦å‰‡",
        "åå­—å€’ç«‹": "è£œè¶³è¦å‰‡",
        "30cm": "è£œè¶³è¦å‰‡",
        "ãƒ¤ãƒãƒ¯ã‚­": "è£œè¶³è¦å‰‡",
        "ã‚¸ãƒ§ãƒŠã‚µãƒ³": "è£œè¶³è¦å‰‡",
        "90åº¦": "è£œè¶³è¦å‰‡",
        "60åº¦": "è£œè¶³è¦å‰‡",
        "tinsica": "åºŠé‹å‹•è©³ç´°è¦å‰‡",
        "å´æ–¹å€’ç«‹": "åºŠé‹å‹•è©³ç´°è¦å‰‡",
        "ä¸èªå®š": "è©³ç´°æŠ€è¡“è¦å‰‡",
        "ç€åœ°ãƒãƒƒãƒˆ": "è©³ç´°æŠ€è¡“è¦å‰‡",
        "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—": "è©³ç´°æŠ€è¡“è¦å‰‡",
        "å›£ä½“ç·åˆ": "è©³ç´°æŠ€è¡“è¦å‰‡",
        "è»Šè¼ªå¤‰å½¢": "è©³ç´°æŠ€è¡“è¦å‰‡"
    }
    
    for keyword, rule_key in scoring_keywords.items():
        if keyword in message:
            if rule_key in SCORING_RULES_KNOWLEDGE:
                return {
                    "response": SCORING_RULES_KNOWLEDGE[rule_key],
                    "conversation_id": "scoring_001"
                }
    
    # æ±ç”¨çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ¤œç´¢
    for keyword, knowledge in GYMNASTICS_KNOWLEDGE.items():
        if keyword in message:
            return {
                "response": knowledge,
                "conversation_id": "test_001"
            }
    
    # ã¤ã‚Šè¼ªã®æŠ€ã«ã¤ã„ã¦ï¼ˆè©³ç´°ç‰ˆï¼‰
    if "ã¤ã‚Šè¼ª" in message and ("dé›£åº¦" in message or "dç´š" in message):
        return {
            "response": """ã¤ã‚Šè¼ªã®Dé›£åº¦æŠ€ï¼ˆ0.4ç‚¹ï¼‰è©³ç´°ï¼š

ã€ä¸»è¦ãªDé›£åº¦æŠ€ã€‘
â€¢ **ä¸­æ°´å¹³** - ä¸¡è…•ã‚’æ°´å¹³ã«ä¿ã¤é™æ­¢æŠ€ï¼ˆ2ç§’ä¿æŒï¼‰
â€¢ **å¾Œæ–¹è»Šè¼ªå€’ç«‹** - å¾Œæ–¹å›è»¢ã‹ã‚‰å€’ç«‹ä½ã¸
â€¢ **å‰æ–¹è»Šè¼ªå€’ç«‹** - å‰æ–¹å›è»¢ã‹ã‚‰å€’ç«‹ä½ã¸
â€¢ **ãƒ›ãƒ³ãƒ1å›ã²ã­ã‚Š** - æ‡¸å‚ã‹ã‚‰1å›ã²ã­ã£ã¦å€’ç«‹
â€¢ **æŒ¯å‹•å€’ç«‹** - å¤§ããªæŒ¯å‹•ã‹ã‚‰å€’ç«‹ä½ã¸
â€¢ **ã‚¢ã‚¶ãƒªã‚¢ãƒ³** - åå­—æ‡¸å‚ã‹ã‚‰æŠ¼ã—ä¸Šã’ã¦æ”¯æŒ

ã€æ¡ç‚¹ãƒã‚¤ãƒ³ãƒˆã€‘
- é™æ­¢æŠ€ã¯2ç§’é–“ã®ä¿æŒãŒå¿…é ˆ
- æŒ¯å‹•æŠ€ã¯æ­£ç¢ºãªæŠ€è¡“å®Ÿæ–½ãŒé‡è¦
- åŠ›æŠ€ã¨æŒ¯å‹•æŠ€ã®ãƒãƒ©ãƒ³ã‚¹ãŒè©•ä¾¡ã•ã‚Œã‚‹""",
            "conversation_id": "test_001"
        }
    
    # åºŠé‹å‹•ã«ã¤ã„ã¦ï¼ˆè©³ç´°ç‰ˆï¼‰
    if "åºŠ" in message and ("ãƒ«ãƒ¼ãƒ«" in message or "æ§‹æˆ" in message or "è¦æ±‚" in message):
        return {
            "response": """åºŠé‹å‹•ã®è©³ç´°ãƒ«ãƒ¼ãƒ«ï¼š

ã€åŸºæœ¬è¦å®šã€‘
- æ¼”æŠ€ã‚¨ãƒªã‚¢: 12mÃ—12m
- æ¼”æŠ€æ™‚é–“: ç”·å­70ç§’ä»¥å†…ã€å¥³å­90ç§’ä»¥å†…
- æ™‚é–“è¶…é: -0.1ç‚¹ï¼ˆ2ç§’ã¾ã§ï¼‰ã€-0.3ç‚¹ï¼ˆ2ç§’è¶…ï¼‰

ã€æ§‹æˆè¦æ±‚ï¼ˆç”·å­ï¼‰ã€‘
1. å‰æ–¹ç³»ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆæŠ€
2. å¾Œæ–¹ç³»ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆæŠ€  
3. å´æ–¹ç³»ã‚¢ã‚¯ãƒ­ãƒãƒƒãƒˆæŠ€
4. åŠ›æŠ€ã¾ãŸã¯é™æ­¢æŠ€

ã€ä¸»ãªæ¸›ç‚¹ã€‘
- ãƒ©ã‚¤ãƒ³æ¸›ç‚¹: 0.1ç‚¹/å›
- ç€åœ°ã®ä¹±ã‚Œ: 0.1ã€œ1.0ç‚¹
- æŠ€ã®ä¸å®Œå…¨å®Ÿæ–½: 0.1ã€œ0.5ç‚¹""",
            "conversation_id": "test_001"
        }
    
    # æ¼”æŠ€æ§‹æˆåˆ†æçµæœã¸ã®å¯¾å¿œ
    if "æ¼”æŠ€æ§‹æˆåˆ†æçµæœ" in message or "dã‚¹ã‚³ã‚¢" in message or "æ”¹å–„ææ¡ˆ" in message:
        return analyze_routine_and_suggest_improvements(message)
    
    # ä¸€èˆ¬çš„ãªä½“æ“ã®æŒ¨æ‹¶
    if any(word in message for word in ["ã“ã‚“ã«ã¡ã¯", "ã¯ã˜ã‚ã¾ã—ã¦", "ã‚ˆã‚ã—ã"]):
        return {
            "response": """AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ï¼ğŸ…

FIGå…¬å¼ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ãŸæ­£ç¢ºãªæƒ…å ±ã‚’æä¾›ã—ã¾ã™ï¼š
â€¢ æŠ€ã®é›£åº¦ãƒ»æ¡ç‚¹åŸºæº–
â€¢ é€£ç¶šæŠ€ï¼ˆCVï¼‰ã®çµ„ã¿åˆã‚ã›  
â€¢ NDæ¸›ç‚¹ã®è©³ç´°
â€¢ å„ç¨®ç›®ã®æ§‹æˆè¦æ±‚
â€¢ æ¼”æŠ€æ§‹æˆã®æœ€é©åŒ–ã‚¢ãƒ‰ãƒã‚¤ã‚¹

ä½•ã§ã‚‚ãŠæ°—è»½ã«ã”è³ªå•ãã ã•ã„ï¼""",
            "conversation_id": "test_001"
        }
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›ç­”
    return {
        "response": f"""ã€Œ{data.get("message", "")}ã€ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ã€‚

ä½“æ“ç«¶æŠ€ã®å°‚é–€çš„ãªè³ªå•ã«ã‚ˆã‚Šè©³ã—ããŠç­”ãˆã§ãã¾ã™ï¼š
â€¢ å„ç¨®ç›®ã®æŠ€ã¨é›£åº¦
â€¢ FIGå…¬å¼ãƒ«ãƒ¼ãƒ«ã®è§£èª¬
â€¢ æ¼”æŠ€æ§‹æˆã®åˆ†æã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹
â€¢ æ¡ç‚¹åŸºæº–ã¨æ¸›ç‚¹é …ç›®

ã©ã®ã‚ˆã†ãªæƒ…å ±ã‚’ãŠæ¢ã—ã§ã™ã‹ï¼Ÿ""",
        "conversation_id": "test_001"
    }