# 体操ルールブック AI チャットアプリ開発ログ

## 2024-07-27

### プロジェクト開始

#### 目的

体操競技のルールブックを元に、チャット形式でルールに関する質問に回答できるスマートフォンアプリを開発する。複雑で難解なルールを、AI を使って分かりやすく解説することを目指す。

#### 初期計画（案）

1.  **MVP（Minimum Viable Product）の定義**:

    - まずは特定の種目（例：跳馬）に絞り、基本的な質疑応答ができるシンプルな Web アプリケーションのプロトタイプを開発します。
    - 機能：質問入力フォーム、回答表示エリア。

2.  **技術選定（案）**:

    - **AI/バックエンド**: Python, LangChain, OpenAI API (または他の LLM), ベクトルデータベース (ChromaDB など)
    - **フロントエンド**: シンプルな Web UI (HTML/CSS/JavaScript) から始め、後にスマホアプリ (Flutter/React Native) へ移行。
    - **データソース**: FIG（国際体操連盟）や JGA（日本体操協会）のルールブック（PDF 形式を想定）。

3.  **当面のタスク**:
    - 開発環境を整える。
    - この `WORK-LOG.md` に進捗を記録していく。
    - ルールブックの PDF ファイルからテキストデータを抽出する方法を確立する。

### 2024-07-27: 開発環境セットアップ

#### 実施内容

- 基本的なプロジェクト構成を作成した。
- Web アプリケーションフレームワークとして `Streamlit` を選択。
- AI 関連ライブラリとして `LangChain`, `OpenAI` を選択。
- PDF 処理、ベクトル DB のライブラリとして `pypdf`, `chromadb` を選択。
- 必要なライブラリを `requirements.txt` にまとめた。
- アプリケーションのエントリポイントとして `app.py` を作成。
- ルールブックデータを格納する `data` ディレクトリを作成。

#### 作成/変更したファイル

- `WORK-LOG.md` (このファイル)
- `requirements.txt`
- `app.py`
- `data/` (ディレクトリ)

---

### 2024-07-27: AI ロジック実装とアプリ連携

#### 実施内容

- ルールブック PDF を読み込み、AI が検索・回答できる形に変換するコアロジックを実装した。
- **RAG (Retrieval-Augmented Generation)** の仕組みを導入。
  1.  **PDF 読み込み**: `pypdf` を利用して `data` ディレクトリの PDF ファイルを読み込む。
  2.  **テキスト分割**: 読み込んだテキストを検索しやすいように小さなチャンクに分割。
  3.  **ベクトル化**: テキストチャンクを `OpenAI` のモデルでベクトル（数値の配列）に変換。
  4.  **ベクトルストア**: ベクトルデータを `ChromaDB` に保存。これにより、質問内容に近い情報を高速に検索できる。初回実行時に DB を `db` ディレクトリに永続化する。
- OpenAI API キーを安全に管理するため、`.env` ファイルを使用する方式を導入した。
- コアロジックを `rulebook_ai.py` として分離し、メインの `app.py` から呼び出す構成に変更。
- `app.py` (Streamlit アプリ) を更新。
  - アプリ起動時にベクトルストアを初期化。
  - ユーザーの質問を受け取り、`rulebook_ai.py` の QA チェーンに渡す。
  - AI からの回答と、回答の根拠となったルールブックの箇所を表示する機能を追加。
- ベクトルデータベースを格納する `db` ディレクトリを作成。

#### 作成/変更したファイル

- `WORK-LOG.md` (このファイル)
- `.env` (OpenAI API キー設定ファイル)
- `rulebook_ai.py` (AI のコアロジック)
- `app.py` (Streamlit アプリケーションの更新)
- `db/` (ベクトル DB 格納用ディレクトリ)

#### 次のステップ

- ユーザーに `.env` ファイルへ自身の OpenAI API キーを設定してもらう。
- アプリケーションを起動し、動作確認を行う。

---

### 2024-07-27: 実行環境トラブルシューティングとアプリ起動

#### 実施内容

- `pip install` 実行時に `externally-managed-environment` エラーが発生したため、Python の仮想環境を導入して解決した。
  - `python3 -m venv venv` コマンドで仮想環境を作成。
  - `venv/bin/pip install -r requirements.txt` を使用して、仮想環境内にライブラリをインストール。
- 仮想環境内の `streamlit` を使用して (`venv/bin/streamlit run app.py`) アプリケーションを正常に起動した。

#### 教訓

- システムの Python 環境への影響を避けるため、プロジェクトごとに仮想環境を作成することが推奨される。これにより、依存関係の衝突を防ぎ、環境の再現性を高めることができる。

#### 作成/変更したファイル

- `WORK-LOG.md` (このファイル)
- `venv/` (Python 仮想環境)

---

### 2024-07-27: 依存関係の警告修正

#### 実施内容

- アプリ実行時に表示されていた `LangChainDeprecationWarning` を解消した。
- `langchain_community.vectorstores.Chroma` の使用は非推奨となっていたため、`langchain-chroma` パッケージに移行した。
  - `requirements.txt` に `langchain-chroma` を追加。
  - `rulebook_ai.py` の `import` 文を `from langchain_chroma import Chroma` に変更。
- 不要になった `vectorstore.persist()` の呼び出しを `rulebook_ai.py` から削除した。

#### 結果

- 警告が解消され、よりクリーンな状態でアプリケーションが動作するようになった。
- MVP（Minimum Viable Product）が完成した。

---

### 2024-07-28: 対話形式チャット機能の実装

#### 実施内容

- アプリケーションを単純な Q&A 形式から、会話の文脈を記憶する対話形式にアップグレードした。
- **AI の記憶機能 (バックエンド)**
  - `rulebook_ai.py` を更新し、`RetrievalQA` チェーンから `ConversationalRetrievalChain` に変更。
  - `ConversationBufferMemory` を導入し、AI が会話履歴を記憶できるようにした。これにより、過去のやり取りを踏まえた回答生成が可能になった。
- **チャット UI (フロントエンド)**
  - `app.py` を全面的に刷新。
  - Streamlit の `st.chat_input` と `st.chat_message` を使用して、一般的なチャットアプリのような UI を構築した。
  - `st.session_state` を活用して、ユーザーと AI の発言履歴をブラウザセッション内で永続化するようにした。

#### 結果

- ユーザー体験が大幅に向上し、より自然な形でルールに関する質問を深掘りできるようになった。
- ChatGPT のようなインタラクティブな対話が可能になった。

---

### 2024-07-28: 対話機能のエラー修正

#### 実施内容

- 対話機能実行時に `Got multiple output keys` エラーが発生した問題を修正した。
- **原因**: `ConversationalRetrievalChain` が `answer` と `source_documents` の 2 つのキーを持つ辞書を返すため、`ConversationBufferMemory` がどちらを履歴として保存すべきか判断できなかった。
- **対策**: `rulebook_ai.py` 内で `ConversationBufferMemory` を初期化する際に `output_key='answer'` を明示的に指定。これにより、メモリは `answer` の値を AI の応答として正しく記憶できるようになった。

#### 結果

- エラーが解消され、対話機能が安定して動作するようになった。

---

### 2024-07-28: 回答生成の精度向上 (プロンプトエンジニアリング)

#### 実施内容

- 日本語の質問に対して、英語のルールブックからでは回答をうまく生成できない問題を解決した。
- **原因**: AI への指示が曖昧で、言語の壁（日本語の質問 vs 英語の資料）をうまく乗り越えられずにいた。
- **対策**: `rulebook_ai.py` にて、`ConversationalRetrievalChain` に渡すプロンプトをカスタマイズ。
  - 「あなたは体操のルール専門家である」という役割設定。
  - 「英語のコンテキストを元に、日本語で回答する」という具体的な指示。
  - 「情報がない場合は正直にそう伝える」という指示。
  - 上記を盛り込んだ `PromptTemplate` を作成し、チェーンに組み込んだ。

#### 結果

- クロスリンガル（日英間）での検索・回答精度が向上した。
- AI がより役割に忠実な、安定した回答を返すようになった。

---

### 2024-07-28: 依存関係のバージョン固定

#### 実施内容

- `openai` ライブラリが既に最新版であることを確認した。
- 今後の開発の安定性と再現性を確保するため、`pip freeze` コマンドを実行し、`requirements.txt` にインストールされている全ライブラリのバージョンを固定（ピニング）した。

#### 結果

- プロジェクトの依存関係が明確になり、誰が実行しても同じ環境を構築できるようになった。

---

### 2024-07-28: 検索精度の改善 (MMR 導入)

#### 実施内容

- 「情報が見つからない」という応答が頻発する問題を改善するため、検索アルゴリズムを強化した。
- **原因**: デフォルトの類似度検索では、質問と完全に一致する情報が見つからない場合に、関連情報を取りこぼすケースがあった。
- **対策**: `rulebook_ai.py` のリトリーバー設定を変更し、検索タイプを `mmr` (Maximal Marginal Relevance) に変更した。これにより、単純な類似度だけでなく、情報の多様性も考慮して検索結果を返すようになり、回答の元となるコンテキストの質が向上した。

#### 結果

- AI がより広範な質問に対して、粘り強く関連情報を見つけ出せるようになり、回答精度が向上した。

---

### 2024-07-28: 参考箇所の日本語訳機能を追加

#### 実施内容

- ユーザーが回答の信頼性をより高く評価できるよう、AI が参考にしたルールブックの箇所（英語）とその日本語訳を両方表示する機能を追加した。
- **翻訳チェーンの追加**: `rulebook_ai.py` に、英語を日本語に翻訳する専門の `get_translator_chain` を作成。翻訳の品質と速度を考慮し、モデルには `gpt-4-turbo` を採用。
- **UI ロジックの変更**: `app.py` を改修。
  - アプリ起動時に翻訳チェーンを初期化。
  - AI が回答を生成した後、その根拠となった `source_documents` をループ処理し、翻訳チェーンに渡して日本語訳を生成。
  - `st.expander`内に、原文と日本語訳を並べて表示するようにした。

#### 結果

- 回答の根拠が原文と日本語訳で明確に示されるようになり、情報の透明性と信頼性が大幅に向上した。
- ユーザーは、必要に応じて原文にあたり、より正確なルール解釈を行うことができるようになった。

---

### 2024-07-29: 言語切り替え機能の実装

#### 実施内容

- 英語版と日本語版のルールブックを切り替えて利用できる機能を実装した。
- **ファイル命名規則の導入**: `data` ディレクトリに `rulebook_en.pdf`, `rulebook_ja.pdf` のように言語コードを付与した PDF を配置するルールを定めた。
- **バックエンドの多言語対応**:
  - `rulebook_ai.py` を改修し、言語コード (`en`/`ja`) を引数に取るようにした。
  - 言語に応じて、`db_en`, `db_ja` のように独立したベクトルデータベースを生成・利用するように変更。
  - AI への指示（プロンプト）も、選択された言語に合わせて最適化するようにした。
- **フロントエンドの改修**:
  - `app.py` に `st.sidebar` を用いて言語選択ドロップダウンを設置。
  - `data` ディレクトリに存在する PDF を自動で検知し、利用可能な言語のみを選択肢として表示。
  - 言語が切り替えられた際に、会話履歴と AI モデルをリセットし、新しい言語設定で再初期化するロジックを実装。
  - 参考箇所の日本語訳機能は、英語モードでのみ表示されるようにした。

#### 結果

- 多言語対応の基盤が完成し、将来的に日本語のルールブックを追加するだけで、機能が拡張できるようになった。
- ユーザーが参照したいルールブックの言語を自由に選択できるようになった。

---

### 2024-07-29: UI の国際化対応

#### 実施内容

- ルールブックの言語設定に合わせて、アプリケーションの UI（タイトル、ボタン、ラベルなど）も動的に切り替わるようにした。
- **UI テキストの外部化**: `app.py` の先頭に、`en` と `ja` の言語コードをキーとする辞書 `UI_TEXTS` を定義。全ての UI 文字列をこの辞書で一元管理するようにした。
- **動的テキスト表示**: `st.session_state.language` の値に応じて `UI_TEXTS` から適切なテキストを読み込み、`st.title()` や `st.chat_input()` などに渡すように変更した。
- **言語選択の改善**: 利用可能な PDF が 1 つしかない場合は、言語選択メニューを非表示にするようにした。

#### 結果

- 言語設定に応じて UI が完全に切り替わるようになり、よりネイティブなユーザー体験を提供できるようになった。
- コード内のハードコーディングされた文字列がなくなり、メンテナンス性が向上した。

---

### 2024-07-29: 翻訳機能の削除と UI のシンプル化

#### 実施内容

- ユーザーからのフィードバックに基づき、参考箇所の自動翻訳機能を削除し、UI をよりシンプルに修正した。
- **背景**: 選択した言語の原文をそのまま表示する方が、ユーザーにとって直感的で分かりやすいと判断。
- **翻訳機能の削除**:
  - `rulebook_ai.py` から、翻訳用の AI チェーン `get_translator_chain` を完全に削除。
  - `app.py` から、翻訳チェーンの呼び出し、翻訳処理のロジック、および関連する UI 要素（スピナー、二段階表示など）をすべて削除。
- **UI の整理**:
  - 参考箇所の表示を、選択言語の原文のみを表示するシンプルな形式に戻した。
  - `UI_TEXTS` 辞書から、不要になった翻訳関連のキーを削除した。

#### 結果

- ユーザー体験がよりシンプルで直感的になった。
- コードがスリムになり、ロジックの可読性とメンテナンス性がさらに向上した。

---

### 2024-07-29: 英語モードの回答言語を英語に変更

#### 実施内容

- ユーザーからのフィードバックに基づき、言語設定が「英語」の際の AI の応答言語を日本語から英語に変更した。
- **背景**: 英語のルールブックを参照している際は、AI との対話も英語で行う方が自然で、一貫性のあるユーザー体験を提供できると判断。
- **プロンプトの修正**: `rulebook_ai.py` の `create_conversational_chain` 内で、`lang` が `en` の場合に適用されるプロンプトテンプレートを、英語の指示と応答を促す内容に更新した。

#### 結果

- 英語モードにおいて、英語での質問に対して AI が英語で回答するようになり、言語設定と動作の一貫性が取れた。
- クロスリンガル処理が不要になったことで、英語モードでの応答精度や安定性の向上が期待される。

---

### 2024-07-29: AI モデルのアップグレードと知識範囲の拡張

#### 実施内容

- AI のコア機能を大幅にアップグレードし、回答性能と範囲を向上させた。
- **言語モデルの更新**:
  - `rulebook_ai.py` で使用するモデルを、OpenAI の最新・高性能モデルである `gpt-4o` に変更した。
- **知識ソースのハイブリッド化**:
  - AI の思考プロセスを、単なる RAG（検索拡張生成）から、より高度なハイブリッド方式に変更。
  - **優先順位 1**: まず提供されたルールブック(PDF)から回答を探す。見つかった場合は、その旨を明記して回答。
  - **優先順位 2**: PDF に情報がない場合、AI 自身の広範な一般知識を利用して回答を試みる。その際は、必ず「ルールブック外の知識である」ことを注記する。
  - この変更のために、`rulebook_ai.py` 内のプロンプトテンプレートを全面的に更新した。

#### 結果

- 回答できない質問が大幅に減り、より幅広い対話が可能になった。
- 回答の信頼性が向上した（ルールブックに基づく回答か、AI の一般知識に基づく回答かが明確になった）。
- 最新モデル `gpt-4o` の採用により、全体的な応答品質と速度の向上が期待される。

---

### 2024-07-29: チャット UI の応答性向上

#### 実施内容

- ユーザーからのフィードバックに基づき、チャットの UI/UX を大幅に改善した。
- **課題**: ユーザーが質問を送信してから AI の回答が表示されるまで、送信した質問が画面から消えてしまう問題があった。
- **対策**: `app.py` のロジックを修正し、ユーザーの入力と AI の応答生成を分離した。
  1.  ユーザーが質問を送信すると、まずその質問内容を即座に会話履歴に追加し、画面を再描画してユーザー側のチャットとして表示する。
  2.  再描画後、最後のメッセージがユーザーのものであることを検知し、AI が応答生成を開始する。その間、AI 側のチャット欄にはスピナー（考え中マーク）が表示される。
  3.  応答が完了すると、AI の回答が会話履歴に追加され、画面に表示される。

#### 結果

- 質問を送信しても、その内容が画面に残り続けるようになり、ユーザーが対話の文脈を失わなくなった。
- AI が思考中であることが視覚的にわかるようになり、体感的な待ち時間が改善された。
- 全体として、一般的なチャットアプリケーションのような、より自然で直感的な操作感を実現した。

---

### 2024-07-29: チャット UI の表示不具合修正（確定版）

#### 実施内容

- 複数回の試行でも解決しなかった、ユーザーの発言が左側に表示される UI の不具合を、根本的なロジックの変更によって修正した。
- **原因**: `st.rerun()` を複数回使用する複雑な状態管理が、Streamlit のレンダリングサイクルと競合し、意図しない表示を引き起こしていた。
- **対策**: Streamlit の公式ドキュメントで推奨されている標準的なチャットアプリケーションの実装方式に、`app.py`のロジックを全面的に書き直した。
  1.  まず、ループで既存のチャット履歴（`st.session_state.messages`）をすべて表示する。
  2.  `st.chat_input`でユーザーの新しい入力を受け付ける。
  3.  入力があった場合、その単一の処理ブロック内で以下を順番に実行する。
      - ユーザーの質問を`"role":"user"`として履歴に追加。
      - `st.chat_message("user")`を使って、ユーザーの質問を画面の右側に表示。
      - AI の応答を生成。
      - `st.chat_message("assistant")`を使って、AI の応答を画面の左側に表示。
      - AI の応答を`"role":"assistant"`として履歴に追加。

#### 結果

- 複雑な`rerun()`の連鎖を廃止し、よりシンプルで堅牢なロジックになった。
- ユーザーの質問が右側に、AI の回答が左側に、意図通りに確実に表示されるようになり、UI の表示不具合が完全に解消された。
- 多大なご迷惑をおかけしたが、最終的に安定した UI を提供できるようになった。

---

### 2024-07-29: AI の応答をより対話的に改善

#### 実施内容

- ユーザーからのフィードバックに基づき、AI の回答をより対話的で親切なものに改善した。
- **課題**: AI が回答して終わってしまい、ユーザーが次に行うべきアクションが分かりにくかった。
- **対策**: `rulebook_ai.py` のプロンプトテンプレートを修正し、AI が回答を生成した後、必ず「より詳細な情報が必要な場合は、具体的な質問をしてください。」（英語版も同様）という一文を付け加えるように指示した。

#### 結果

- AI がユーザーに対話を促すようになり、より自然でインタラクティブな体験が実現された。
- ユーザーは AI の能力の限界を自然に理解し、質問を深掘りしていくという、このアプリの最適な使い方に誘導されるようになった。

---

### 2024-07-29: AI の自己認識機能の実装

#### 実施内容

- AI がアプリケーション自身の機能（対応言語やその切り替え方法など）について回答できるように、自己認識機能を追加した。
- **課題**: 「日本語に対応しているか？」といったアプリに関する質問に対し、AI は一般的な知識でしか答えられなかった。
- **対策**:
  - `rulebook_ai.py`の`create_conversational_chain`を改修。AI に渡すプロンプトの先頭に、「アプリケーションの自己紹介」というセクションを動的に生成して追加するようにした。
  - この自己紹介文には、現在の言語モード、対応言語のリスト、言語の切り替え方法といった、`app.py`から渡されたリアルタイムの情報が含まれる。
  - AI への指示も更新し、いかなる質問に対しても、まずこの「自己紹介」セクションを参照して回答を試みるようにした。

#### 結果

- AI が「メタ知識（自分自身に関する知識）」を持つようになり、アプリケーションに関する質問に対して、状況に応じた的確な回答ができるようになった。
- 例えば、英語モード時に日本語対応について尋ねられると「はい、対応しています。サイドバーで切り替えてください」といった、よりユーザーに寄り添った案内が可能になった。
- AI アシスタントとしての完成度が大きく向上した。

---

### 2024-07-30: UI にロゴを追加

#### 実施内容

- アプリケーションのブランディング向上のため、UI にロゴを表示する機能を追加した。
- **アセット管理**: プロジェクトルートに`assets`ディレクトリを作成し、`logo.png`を配置する運用ルールを定めた。
- **UI の変更**: `app.py`を修正し、サイドバーの最上部に`st.sidebar.image()`を使ってロゴ画像を表示するようにした。ファイルが存在しない場合でもエラーにならないよう、`os.path.exists()`で事前に存在確認を行う処理も追加した。

#### 結果

- UI にロゴが追加され、アプリケーションの見た目がより洗練され、本格的なものになった。

---

### 2024-07-30: チャットリセット機能の追加

#### 実施内容

- ユーザーが任意のタイミングで会話をリセットできるよう、サイドバーに「チャットをリセット」ボタンを追加した。
- **UI の変更**: `app.py`のサイドバーに`st.sidebar.button`を配置。ボタンのラベルも UI の言語設定に連動するようにした。
- **リセット処理**: ボタンがクリックされると、以下の処理を実行する。
  1.  会話履歴が格納されている`st.session_state.messages`を空のリストにする。
  2.  AI の記憶を保持している`st.session_state.qa_chain`をセッションから削除する。これにより、次回のアクション時に記憶がリセットされた新しい AI が作成される。
  3.  `st.rerun()`を呼び出して、画面を即座に更新する。

#### 結果

- 会話が長くなったり、話題を変えたりしたい場合に、ユーザーが簡単に状態をリフレッシュできるようになった。
- アプリケーションのユーザビリティが向上した。

---

### 2024-07-30: リセットボタンの配置変更

#### 実施内容

- ユーザーからのフィードバックに基づき、チャットのリセットボタンをサイドバーからメイン画面の右上に移動した。
- **背景**: テキスト入力欄の横への配置は Streamlit の仕様上困難であるため、代替案として、より一般的でアクセスしやすいヘッダー右側に配置することを提案し、承認された。
- **UI の変更**: `app.py`を修正し、`st.columns`を使用してメインタイトルとリセットボタンを横並びに配置した。

#### 結果

- リセット機能がより目立ち、アクセスしやすくなった。
- アプリケーションの主要な操作がメイン画面に集約され、UI の直感性が向上した。

---

### 2024-07-30: アプリケーションタイトルの変更

#### 実施内容

- ユーザーの指示に基づき、アプリケーションのタイトルを `Gymnastics Rulebook AI Chat` から `Gymnastics AI Chat` に変更した。
- **UI の変更**: `app.py` の `UI_TEXTS` 辞書内にある `en` と `ja` の両方の `title` の値を更新した。

#### 結果

- よりシンプルで覚えやすいアプリケーション名になった。

---

### 2024-07-30: D スコア計算モードの追加とモード切替機能の実装

#### 実施内容

- アプリケーションに、新機能である「D スコア計算」モードを追加し、既存の「ルールブック AI チャット」モードと切り替えられるように、全体の構造を改修した。
- **モード切替 UI**: `app.py`のサイドバーに、2 つのモードを選択するラジオボタン(`st.sidebar.radio`)を設置した。
- **コードのモジュール化**:
  - `app.py`のロジックを`render_chat_mode()`と`render_d_score_mode()`の 2 つの関数に分割し、モードに応じて呼び出すようにした。
  - D スコア計算機能のロジックを格納するため、新しく`d_score_calculator.py`を作成した。ここには技のデータベースや計算式の雛形を配置し、今後の機能拡張の土台を築いた。
- **UI テキストの拡充**: `app.py`の`UI_TEXTS`辞書に、モード選択や D スコア計算画面用の文言を追加した。

#### 結果

- アプリケーションが単一機能から多機能へと拡張可能な、スケーラブルな構造に進化した。
- 新機能である D スコア計算モードの骨格が完成し、今後の具体的なロジック実装の準備が整った。

---

### 2024-07-30: D スコア計算モードの UI 改善（技の削除機能）

#### 実施内容

- D スコア計算モードにおいて、一度追加した技をリストから削除できる機能を実装した。
- **UI の変更**:
  - `app.py`の`render_d_score_mode`関数内を修正。
  - 構成内の技を表示するループ処理の中で`st.columns`を使い、技名の横に「削除」ボタン(`st.button`)を配置した。
  - 各ボタンが意図しない動作を引き起こさないよう、ループのインデックス `i` を使って、`key=f"delete_skill_{i}"`のようにユニークなキーを設定した。
- **ロジックの実装**:
  - 「削除」ボタンが押されると、`st.session_state.selected_skills.pop(i)`を実行して、該当する技をリストから削除。
  - `st.rerun()`を呼び出し、リストから技が消えた状態を即座に UI に反映させ、D スコアも再計算されるようにした。

#### 結果

- ユーザーが試行錯誤しながら演技構成を組み立てられるようになり、D スコア計算機能のユーザビリティが大幅に向上した。

---

### 2024-07-30: D スコア計算モードの UI 改善（技の変更機能）

#### 実施内容

- D スコア計算モードにおいて、一度追加した技をリストから「削除」するだけでなく、「変更（入れ替え）」できる機能を実装した。
- **UI の変更**:
  - `app.py`の`render_d_score_mode`関数内を修正。
  - 構成内の各技の横に「変更」ボタンを設置。
  - 「変更」ボタンが押されると、UI が「変更モード」に切り替わる。技選択 UI のボタンが「入れ替え」に変わり、キャンセルボタンも表示される。
- **ロジックの実装**:
  - セッション状態に`editing_skill_index`を追加し、どの技が変更対象かを管理する。
  - 「入れ替え」ボタンが押されると、リスト内の古い技の情報を、新しく選択された技の情報で上書きする。
  - 入れ替え、またはキャンセルが完了すると、`editing_skill_index`をリセットして通常モードに戻る。

#### 結果

- 技を一度削除してから追加し直す手間がなくなり、より直感的でスムーズな構成編集が可能になった。
- アプリケーションの操作性がさらに向上した。

---

### 2024-07-30: D スコア計算モードの UI 改善（インライン編集機能）

#### 実施内容

- ユーザーからのフィードバックに基づき、技の「変更」機能を、より直感的な「インライン編集（その場で編集）」方式に改修した。
- **UI の変更**:
  - `app.py`の`render_d_score_mode`関数内を修正。
  - 構成リスト内の「変更」ボタンを押すと、その行が技名テキストから「新しい技を選択するドロップダウン」と「✓」「×」ボタンに切り替わるようにした。
  - 画面上部にあった技選択エリアは、常に新しい技を追加するためだけの UI として役割を明確化した。
- **ロジックの実装**:
  - `st.session_state.editing_skill_index`で「どの技が変更モードか」を管理する点は維持。
  - 構成リストの`for`ループ内で、現在のインデックスが変更対象かどうかを判定し、表示する UI を動的に切り替えるロジックを実装した。

#### 結果

- ユーザーが視線を移動させることなく、変更したい技のその場所で、シームレスに入れ替え操作を行えるようになった。
- 「どこで技を追加し、どこで既存の技を編集するのか」が明確になり、UI の分かりやすさが格段に向上した。

---

### 2024-07-30: D スコア計算モードの種目リストを更新

#### 実施内容

- D スコア計算モードの種目選択リストを、不完全なサンプルから正式な男子 6 種目に更新した。
- **データ更新**: `d_score_calculator.py`内の`SKILL_DATABASE`のキーを、ユーザーから提供された正式名称（例: "FX - Floor Exercise"）に修正した。
- **今後の拡張性**: 未実装の種目についても、空のリストとしてキーを追加し、将来の技データ追加に備えた。

#### 結果

- D スコア計算機能が、実際の競技に即した、より実践的なものになった。

---

### 2024-07-30: AI による技データベースの自動構築

#### 実施内容

- 将来のルール変更に柔軟に対応できるよう、PDF から技リストを自動で抽出し、データベース化する機能を実装した。
- **PDF 解析スクリプトの高度化**:
  - `utils/pdf_parser.py`を、正規表現ベースから AI(gpt-4o)ベースのロジックに全面的に刷新した。
  - 各種目（ゆか、あん馬など）の技リストが記載されているページ範囲を定義し、その範囲のテキストを抽出。
  - 抽出したテキストを AI に渡し、「このテキストから技の ID, 名前, グループ, 難度を JSON 形式で抜き出して」と指示することで、高精度なデータ抽出を実現した。
- **動的データベースの構築**:
  - `d_score_calculator.py`を改修し、アプリ起動時に`data`ディレクトリ内の`skills_xx.json`ファイルを全て読み込み、`SKILL_DATABASE`を動的に構築するようにした。
- **スクリプトの実行**: `pdf_parser.py`を実行し、ルールブック PDF から男子 5 種目の技データを抽出し、それぞれ JSON ファイルとして`data`ディレクトリに保存した。

#### 結果

- **メンテナンス性が劇的に向上**: 将来ルールが改訂された際、新しい PDF を配置して`pdf_parser.py`を実行するだけで、技データベースを最新の状態に更新できるようになった。
- D スコア計算モードの技選択ドロップダウンに、実際の競技で使われる網羅的な技リストが表示されるようになり、極めて実践的なツールへと進化した。

---

### 2024-07-30: D スコア計算ロジックの実装（グループ要求対応）

#### 実施内容

- D スコア計算機能を、単なる難度点の合計から、実際のルールに基づいた計算ロジックへとアップグレードした。
- **ルール定義の追加**: `d_score_calculator.py`に、種目ごとの「技のカウント数」「要求されるグループ数」「要求を満たした際のボーナス点」を定義した`APPARATUS_RULES`を追加。
- **計算ロジックの実装**:
  1.  追加された技を難度点順にソートし、上位から種目ルールに応じた数を計算対象とする。
  2.  計算対象の技のグループ数を`set`で集計し、要求されるグループ数を満たしているか判定する。
  3.  要求を満たしている場合、ボーナス点（2.0 点）を加算する。
  4.  最終的な D スコアと、要求の充足状況を示すステータスメッセージ（例：「要求不足: (3/5 グループ)」）を返すようにした。
- **UI の更新**: `app.py`を修正し、計算された D スコアと共に、このステータスメッセージも表示するようにした。

#### 結果

- 極めて実践的な D スコア計算機能が完成した。
- ユーザーは、構成を組み立てながら、グループ要求を満たしているかどうかをリアルタイムで確認できるようになった。

---

### 2024-07-31: D スコア表示の改善（内訳の明確化）

#### 実施内容

- ユーザーが D スコアの構成要素を直感的に理解できるよう、表示方法を改善した。
- **計算ロジックの変更**: `d_score_calculator.py`の`calculate_d_score`関数が、最終的な合計点だけでなく、その内訳である「難度点の合計」と「ボーナス点」も個別に返すように変更した。
- **UI の変更**: `app.py`を修正し、`st.metric`を用いて、3 つの要素（難度点、ボーナス点、合計 D スコア）を横並びで分かりやすく表示するようにした。

#### 結果

- D スコアがどのように計算されているかが一目でわかるようになり、アプリケーションの透明性と教育的な価値が向上した。

---

### 2024-07-31: 日本語モードの有効化

#### 実施内容

- ユーザーが提供した日本語版ルールブック (`rulebook_ja.pdf`) をシステムに統合し、日本語でのチャット機能を完全に有効化した。
- **動的言語検出**: `app.py`に実装済みのロジックが`data/rulebook_ja.pdf`の存在を自動で検知し、サイドバーの言語選択オプションに「日本語」を追加。
- **データベースの自動生成**: ユーザーが初めて「日本語」を選択した際に、`setup_vectorstore(lang="ja")`が呼び出され、日本語 PDF の内容を解析・ベクトル化した知識データベース `db_ja` が自動で構築される。
- **プロンプトの自動切り替え**: 同じく実装済みのロジックにより、日本語モードでは`prompts/rulebook_chat_ja.txt`が自動で読み込まれ、AI が日本語で応答するようになる。

#### 結果

- 当初の目的であった、日本語でのルールブック AI チャットが完全に利用可能となった。
- PDF を追加するだけで、システムの再構築やコードの変更なしに新言語へ対応できる、本アプリケーションの高い拡張性が証明された。

---

### 2024-07-31: パスワード付き PDF への対応

#### 実施内容

- パスワードで保護された PDF ファイルを扱えるように、システムの堅牢性を向上させた。
- **課題**: 暗号化された PDF を読み込もうとすると、`cryptography`ライブラリがないためエラーが発生していた。
- **対策**:
  1.  PDF のパスワードを`.env`ファイルに`PDF_PASSWORD="..."`として安全に設定する運用ルールを導入した。
  2.  `requirements.txt`に、暗号化処理に必須の`cryptography`ライブラリを追加。
  3.  `rulebook_ai.py`と`utils/pdf_parser.py`の両方で、PDF を読み込む際に`.env`ファイルから`PDF_PASSWORD`を読み取り、使用するように修正。パスワードが設定されていない場合は、従来通りパスワードなしで読み込みを試みる。
  4.  パスワードが間違っている場合などに備え、`utils/pdf_parser.py`に詳細なエラーハンドリングを追加した。

#### 結果

- パスワードで保護された公式ルールブックなども、安全かつ柔軟に扱えるようになった。
- アプリケーションの実用性がさらに向上した。

---

### 2024-07-31: D スコア計算モードの多言語対応

#### 実施内容

- D スコア計算モードの種目選択 UI が、アプリケーション全体の言語設定と連動するように修正した。
- **データ構造の変更**: `d_score_calculator.py`内の種目を管理する辞書のキーを、"FX - Floor Exercise"のような表示名から、"FX"のような言語に依存しないコードに変更した。
- **UI テキストの拡充**: `app.py`の`UI_TEXTS`辞書に、各種目コードに対応する日本語名（"ゆか"など）と英語名（"FX - Floor Exercise"など）を追加した。
- **UI ロジックの変更**: D スコア計算モードの種目選択`selectbox`が、現在の言語設定に応じて`UI_TEXTS`から適切な表示名を読み込むようにロジックを修正した。

#### 結果

- D スコア計算モードも完全に多言語対応となり、より一貫性のあるユーザー体験を提供できるようになった。

---

### 2024-07-31: 技データベースの CSV 方式への移行

#### 実施内容

- ユーザーからの提案に基づき、保守性と正確性を最大限に高めるため、技データベースの管理方法を、PDF からの自動抽出方式から、**手動で管理する CSV ファイル方式**に全面的に移行した。
- **PDF 解析機能の廃止**: 不安定だった`utils/pdf_parser.py`をプロジェクトから完全に削除した。
- **CSV ローダーの実装**:
  - `d_score_calculator.py`を改修し、`pandas`ライブラリを使って`data/skills.csv`を読み込み、`SKILL_DATABASE`を構築する`load_skills_from_csv`関数を実装した。
  - CSV ファイルが存在しない場合でもアプリがエラーにならないよう、警告を表示して空のデータベースを返す、堅牢な設計にした。
- **サンプルデータの作成**: 動作確認のため、`data/skills.csv`に数件のサンプルデータを初期状態で配置した。

#### 結果

- **データの完全な制御**: 専門家であるユーザーが、技データの品質を 100%管理できるようになった。
- **将来の保守性が劇的に向上**: ルール改訂時も、ユーザーは使い慣れた表計算ソフトで`skills.csv`を更新するだけで、アプリケーションを最新の状態に保つことができる。
- AI の不確実な抽出処理に依存しない、極めて安定したシステムが完成した。

---

### AI の設計思想と仕様（まとめ）

本アプリケーションの AI は、以下の思想に基づいて設計されている。

1.  **ルールブック第一主義**:
    - AI は、提供された PDF（ルールブック）の情報を最優先の根拠として回答を生成する。
    - このため、PDF に記載されている情報に対しては、高い正確性が期待できる。
2.  **一般知識による補完**:
    - ルールブックに情報が存在しない場合、AI は自身の持つ広範な一般知識（`gpt-4o`の知識）を用いて回答を試みる。
    - その際、必ず「ルールブック外の知識である」ことを明記し、ユーザーに情報の出所を明確に伝える。
3.  **対話による情報深掘りの推奨**:
    - AI は一度にルールブックのすべてを読めるわけではなく、質問に最も関連性の高い数ページを抜粋して回答を要約している。
    - そのため、網羅的な情報を一度に得ることは意図的に避けられている。
    - ユーザーが広い質問から始め、具体的な追加質問を重ねることで、対話を通じて必要な情報にたどり着けるように設計されている。AI はこれを促進するために、回答の最後に追加質問を促す。
